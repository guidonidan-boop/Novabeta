<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova (beta) - Sostenibilità Digitale</title>
    <meta name="description" content="Assistente AI per valutare la sostenibilità digitale dei contenuti web">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons via CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* Custom styles for animations and components */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .drag-active {
            border-color: #16a34a !important;
            background-color: #f0fdf4 !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Print styles */
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
    <div id="app"></div>

    <script>
        // Nova Sustainability Analyzer - Single File Version
        class NovaSustainabilityAnalyzer {
            constructor() {
                this.uploadedImage = null;
                this.analysisResults = null;
                this.isAnalyzing = false;
                this.dragActive = false;
                this.error = null;
                
                this.init();
            }
            
            init() {
                this.render();
                this.attachEventListeners();
                this.initializeLucideIcons();
            }
            
            initializeLucideIcons() {
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            attachEventListeners() {
                // File upload events
                const fileInput = document.getElementById('file-upload');
                const uploadArea = document.getElementById('upload-area');
                const analyzeBtn = document.getElementById('analyze-btn');
                const removeBtn = document.getElementById('remove-btn');
                const downloadBtn = document.getElementById('download-btn');
                
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileInput(e));
                }
                
                if (uploadArea) {
                    uploadArea.addEventListener('dragenter', (e) => this.handleDrag(e));
                    uploadArea.addEventListener('dragover', (e) => this.handleDrag(e));
                    uploadArea.addEventListener('dragleave', (e) => this.handleDrag(e));
                    uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
                }
                
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', () => this.analyzeImage());
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => this.removeImage());
                }
                
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => this.downloadCertificate());
                }
            }
            
            handleDrag(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const uploadArea = document.getElementById('upload-area');
                if (e.type === "dragenter" || e.type === "dragover") {
                    this.dragActive = true;
                    uploadArea?.classList.add('drag-active');
                } else if (e.type === "dragleave") {
                    this.dragActive = false;
                    uploadArea?.classList.remove('drag-active');
                }
            }
            
            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const uploadArea = document.getElementById('upload-area');
                uploadArea?.classList.remove('drag-active');
                this.dragActive = false;
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    this.handleFile(e.dataTransfer.files[0]);
                }
            }
            
            handleFileInput(e) {
                if (e.target.files && e.target.files[0]) {
                    this.handleFile(e.target.files[0]);
                }
            }
            
            handleFile(file) {
                this.error = null;
                
                const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml'];
                if (!validTypes.includes(file.type)) {
                    this.error = 'Formato file non supportato. Usa JPG, PNG, WebP o SVG.';
                    this.render();
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    this.error = 'File troppo grande. Dimensione massima: 10MB.';
                    this.render();
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.uploadedImage = {
                        file: file,
                        url: e.target.result,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    };
                    this.analysisResults = null;
                    this.render();
                };
                reader.onerror = () => {
                    this.error = 'Errore durante la lettura del file.';
                    this.render();
                };
                reader.readAsDataURL(file);
            }
            
            removeImage() {
                this.uploadedImage = null;
                this.analysisResults = null;
                this.error = null;
                this.render();
            }
            
            async loadImageToCanvas(imageUrl) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            const maxSize = 800;
                            const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            resolve({
                                canvas,
                                ctx,
                                imageData,
                                originalWidth: img.width,
                                originalHeight: img.height,
                                scaleFactor: scale
                            });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = () => reject(new Error('Impossibile caricare l\'immagine'));
                    img.src = imageUrl;
                });
            }
            
            analyzeColors(imageData) {
                const data = imageData.data;
                const colors = new Map();
                const pixels = data.length / 4;
                let validPixels = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const a = data[i + 3];
                    
                    if (a < 128) continue;
                    validPixels++;
                    
                    const rGroup = Math.floor(r / 16) * 16;
                    const gGroup = Math.floor(g / 16) * 16;
                    const bGroup = Math.floor(b / 16) * 16;
                    
                    const colorKey = `${rGroup},${gGroup},${bGroup}`;
                    colors.set(colorKey, (colors.get(colorKey) || 0) + 1);
                }
                
                const sortedColors = Array.from(colors.entries())
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10)
                    .map(([color, count]) => {
                        const [r, g, b] = color.split(',').map(Number);
                        return {
                            rgb: { r, g, b },
                            hex: `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`,
                            count,
                            percentage: validPixels > 0 ? (count / validPixels * 100).toFixed(2) : 0
                        };
                    });

                const avgBrightness = sortedColors.reduce((sum, color) => {
                    const luminance = 0.2126 * color.rgb.r + 0.7152 * color.rgb.g + 0.0722 * color.rgb.b;
                    return sum + luminance * parseFloat(color.percentage);
                }, 0) / 100;

                return {
                    dominantColors: sortedColors,
                    isDarkTheme: avgBrightness < 128,
                    averageBrightness: Math.round(avgBrightness),
                    totalValidPixels: validPixels
                };
            }
            
            calculateWCAGContrast(color1, color2) {
                const getLuminance = (r, g, b) => {
                    const [rs, gs, bs] = [r, g, b].map(c => {
                        c = c / 255;
                        return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
                    });
                    return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
                };

                const l1 = getLuminance(color1.r, color1.g, color1.b);
                const l2 = getLuminance(color2.r, color2.g, color2.b);
                
                const lighter = Math.max(l1, l2);
                const darker = Math.min(l1, l2);
                
                return (lighter + 0.05) / (darker + 0.05);
            }
            
            analyzeContrasts(colorAnalysis) {
                const colors = colorAnalysis.dominantColors;
                const contrasts = [];
                
                const significantColors = colors.filter(color => parseFloat(color.percentage) > 2);
                
                for (let i = 0; i < Math.min(significantColors.length, 5); i++) {
                    for (let j = i + 1; j < Math.min(significantColors.length, 5); j++) {
                        const contrast = this.calculateWCAGContrast(significantColors[i].rgb, significantColors[j].rgb);
                        contrasts.push({
                            color1: significantColors[i],
                            color2: significantColors[j],
                            ratio: contrast,
                            wcagAA: contrast >= 4.5,
                            wcagAAA: contrast >= 7.0,
                            combinedWeight: parseFloat(significantColors[i].percentage) + parseFloat(significantColors[j].percentage)
                        });
                    }
                }
                
                contrasts.sort((a, b) => (b.ratio * b.combinedWeight) - (a.ratio * a.combinedWeight));
                
                const bestContrast = contrasts.length > 0 ? contrasts[0] : null;
                const maxContrast = bestContrast ? bestContrast.ratio : 1;
                const avgContrast = contrasts.length > 0 ? 
                    contrasts.reduce((sum, c) => sum + c.ratio, 0) / contrasts.length : 1;
                
                const aaCompliant = contrasts.filter(c => c.wcagAA).length;
                const aaaCompliant = contrasts.filter(c => c.wcagAAA).length;
                const total = contrasts.length;
                
                let wcagLevel = 'Fail';
                let accessibilityScore = 0;
                
                if (total > 0 && bestContrast) {
                    const weightedScore = Math.min(maxContrast * (bestContrast.combinedWeight / 100), maxContrast);
                    
                    if (weightedScore >= 7.0) {
                        wcagLevel = 'AAA';
                        accessibilityScore = 85 + Math.min(15, (weightedScore - 7) * 2);
                    } else if (weightedScore >= 4.5) {
                        wcagLevel = 'AA';
                        accessibilityScore = 65 + Math.min(20, (weightedScore - 4.5) * 6);
                    } else if (weightedScore >= 3.0) {
                        wcagLevel = 'A';
                        accessibilityScore = 35 + Math.min(30, (weightedScore - 3.0) * 12);
                    } else {
                        wcagLevel = 'Fail';
                        accessibilityScore = Math.min(35, weightedScore * 8);
                    }
                    
                    if (total > 0) {
                        const complianceBonus = (aaCompliant / total) * 10;
                        accessibilityScore = Math.min(100, accessibilityScore + complianceBonus);
                    }
                }

                return {
                    contrasts: contrasts.slice(0, 5),
                    maxContrast: parseFloat(maxContrast.toFixed(2)),
                    averageContrast: parseFloat(avgContrast.toFixed(2)),
                    wcagLevel,
                    accessibilityScore: Math.round(Math.max(0, Math.min(100, accessibilityScore))),
                    aaCompliant,
                    aaaCompliant,
                    totalPairs: total,
                    bestContrastPair: bestContrast
                };
            }
            
            calculateEnvironmentalImpact(image, colorAnalysis) {
                const sizeInMB = image.size / (1024 * 1024);
                
                // Valori standardizzati The Shift Project (2019) e Water Footprint Network
                const co2PerMB = 20;  // grammi CO2 per MB
                const waterPerMB = 0.2; // litri acqua per MB
                const energyPerMB = 0.0055; // kWh per MB
                
                let co2PerView = sizeInMB * co2PerMB;
                let waterPerView = sizeInMB * waterPerMB;
                let energyKWh = sizeInMB * energyPerMB;
                
                const formatMultipliers = {
                    'image/webp': 0.8,
                    'image/png': 1.3,
                    'image/jpeg': 1.0,
                    'image/svg+xml': 0.4,
                };
                
                const formatMultiplier = formatMultipliers[image.type] || 1.0;
                const sizeMultiplier = sizeInMB > 1 ? 1.5 : sizeInMB > 0.5 ? 1.2 : 1.0;
                const themeMultiplier = colorAnalysis.isDarkTheme ? 0.85 : 1.0;
                
                co2PerView *= formatMultiplier * sizeMultiplier * themeMultiplier;
                waterPerView *= formatMultiplier * sizeMultiplier;
                energyKWh *= formatMultiplier * sizeMultiplier * themeMultiplier;
                
                const optimalSizeMB = 0.15;
                const sizeRatio = sizeInMB / optimalSizeMB;
                let score = Math.max(0, 100 - (sizeRatio - 1) * 40);
                
                if (image.type === 'image/webp') score += 10;
                else if (image.type === 'image/png' && sizeInMB > 0.2) score -= 15;
                else if (image.type === 'image/svg+xml') score += 15;
                
                if (colorAnalysis.isDarkTheme) score += 5;
                
                score = Math.max(0, Math.min(100, score));
                
                const recommendations = [];
                if (sizeInMB > 0.5) recommendations.push("Riduci dimensioni file: obiettivo <500KB");
                if (sizeInMB > 1.0) recommendations.push("File troppo grande per web: comprimi significativamente");
                if (image.type === 'image/png' && sizeInMB > 0.2) recommendations.push("Per foto usa JPEG invece di PNG");
                if (image.type !== 'image/webp' && sizeInMB > 0.1) recommendations.push("Considera WebP per -20% dimensioni");
                if (!colorAnalysis.isDarkTheme && colorAnalysis.averageBrightness > 180) recommendations.push("Riduci luminosità per dispositivi OLED");
                
                const equivalences = {
                    co2: { 
                        carMeters: Math.round(co2PerView / 0.12),
                        treesMinutes: (co2PerView / (22000 / (365 * 24 * 60))).toFixed(1)
                    },
                    energy: { 
                        ledSeconds: Math.round((energyKWh / 0.01) * 3600),
                        phoneCharges: (energyKWh / 0.018).toFixed(3)
                    },
                    water: { 
                        drops: Math.round(waterPerView / 0.00005)
                    }
                };
                
                return {
                    co2PerView: parseFloat(co2PerView.toFixed(2)),
                    waterPerView: parseFloat(waterPerView.toFixed(3)),
                    energyKWh: parseFloat(energyKWh.toFixed(6)),
                    score: Math.round(score),
                    recommendations,
                    equivalences,
                    sizeEfficiency: optimalSizeMB / sizeInMB,
                    formatEfficiency: 1 / formatMultiplier
                };
            }
            
            async analyzeImage() {
                if (!this.uploadedImage) {
                    this.error = 'Nessuna immagine caricata';
                    this.render();
                    return;
                }
                
                this.isAnalyzing = true;
                this.error = null;
                this.render();
                
                try {
                    const { canvas, ctx, imageData, originalWidth, originalHeight, scaleFactor } = await this.loadImageToCanvas(this.uploadedImage.url);
                    
                    const colorAnalysis = this.analyzeColors(imageData);
                    const contrastAnalysis = this.analyzeContrasts(colorAnalysis);
                    const environmentalImpact = this.calculateEnvironmentalImpact(this.uploadedImage, colorAnalysis);
                    
                    // Simplified font analysis for single file version
                    const fontAnalysis = {
                        score: 85,
                        fontType: 'system',
                        licensing: 'Sistema/Nativo',
                        efficiency: 'Alta',
                        textDensity: 0,
                        confidence: 0.8,
                        recommendations: []
                    };
                    
                    const weights = {
                        environmental: 0.4,
                        accessibility: 0.35,
                        economic: 0.25
                    };
                    
                    const overallScore = Math.round(
                        (environmentalImpact.score * weights.environmental + 
                         contrastAnalysis.accessibilityScore * weights.accessibility + 
                         fontAnalysis.score * weights.economic)
                    );
                    
                    this.analysisResults = {
                        environmental: {
                            score: environmentalImpact.score,
                            fileSize: this.uploadedImage.size,
                            format: this.uploadedImage.type,
                            co2Impact: environmentalImpact.co2PerView,
                            waterImpact: environmentalImpact.waterPerView,
                            energyImpact: environmentalImpact.energyKWh,
                            isDarkTheme: colorAnalysis.isDarkTheme,
                            averageBrightness: colorAnalysis.averageBrightness,
                            recommendations: environmentalImpact.recommendations,
                            equivalences: environmentalImpact.equivalences,
                            sizeEfficiency: environmentalImpact.sizeEfficiency,
                            formatEfficiency: environmentalImpact.formatEfficiency
                        },
                        accessibility: {
                            score: contrastAnalysis.accessibilityScore,
                            contrast: contrastAnalysis.averageContrast,
                            maxContrast: contrastAnalysis.maxContrast,
                            wcagLevel: contrastAnalysis.wcagLevel,
                            textDetected: false,
                            textCoverage: 0,
                            textConfidence: 0,
                            contrastPairs: contrastAnalysis.totalPairs,
                            aaCompliant: contrastAnalysis.aaCompliant,
                            aaaCompliant: contrastAnalysis.aaaCompliant,
                            bestContrastPair: contrastAnalysis.bestContrastPair,
                            readability: contrastAnalysis.wcagLevel === 'AAA' ? 'Eccellente' : 
                                        contrastAnalysis.wcagLevel === 'AA' ? 'Buona' : 
                                        contrastAnalysis.wcagLevel === 'A' ? 'Sufficiente' : 'Insufficiente'
                        },
                        economic: fontAnalysis,
                        overall: overallScore,
                        metadata: {
                            dominantColors: colorAnalysis.dominantColors.slice(0, 5),
                            textRegions: 0,
                            analysisTimestamp: new Date().toISOString(),
                            imageSize: {
                                width: canvas.width,
                                height: canvas.height,
                                originalWidth,
                                originalHeight,
                                aspectRatio: parseFloat((originalWidth / originalHeight).toFixed(2))
                            },
                            validPixels: colorAnalysis.totalValidPixels,
                            processingNote: scaleFactor < 1 ? `Immagine ridimensionata per analisi (${Math.round(scaleFactor*100)}%)` : 'Analizzata a dimensione originale'
                        }
                    };
                    
                } catch (error) {
                    console.error('Errore durante analisi:', error);
                    this.error = 'Errore durante analisi: ' + error.message;
                }
                
                this.isAnalyzing = false;
                this.render();
            }
            
            getScoreColor(score) {
                if (score >= 80) return 'text-green-600';
                if (score >= 60) return 'text-yellow-600';
                if (score >= 40) return 'text-orange-600';
                return 'text-red-600';
            }
            
            getScoreBadge(score) {
                if (score >= 80) return 'Eccellente';
                if (score >= 60) return 'Buono';
                if (score >= 40) return 'Sufficiente';
                return 'Da migliorare';
            }
            
            downloadCertificate() {
                if (!this.analysisResults || !this.uploadedImage) {
                    this.error = 'Nessuna analisi disponibile per il certificato';
                    this.render();
                    return;
                }
                
                const fileName = `certificato-sostenibilita-${this.uploadedImage.name.replace(/\.[^/.]+$/, "")}.html`;
                
                const html = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificato Sostenibilità Digitale - ${this.uploadedImage.name}</title>
    <style>
        body { font-family: 'Arial', sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; color: #1f2937; background: #f8fafc; }
        .header { text-align: center; background: #ffffff; color: #1f2937; padding: 30px; border-radius: 12px; margin-bottom: 30px; border: 3px solid #16a34a; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { color: #16a34a; margin: 0 0 15px 0; font-size: 2.2em; }
        .score { font-size: 4em; font-weight: bold; color: ${this.analysisResults.overall >= 80 ? '#16a34a' : this.analysisResults.overall >= 60 ? '#d97706' : this.analysisResults.overall >= 40 ? '#ea580c' : '#dc2626'}; margin: 20px 0; }
        .section { margin: 20px 0; padding: 25px; border: 2px solid #e5e7eb; border-radius: 8px; background: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .metric { display: flex; justify-content: space-between; margin: 12px 0; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌱 Nova (beta) - Certificato Sostenibilità Digitale</h1>
        <div style="margin: 15px 0; color: #6b7280;">
            <strong>File:</strong> ${this.uploadedImage.name}<br>
            <strong>Dimensione:</strong> ${(this.uploadedImage.size / (1024*1024)).toFixed(2)} MB<br>
            <strong>Data analisi:</strong> ${new Date().toLocaleDateString('it-IT')}
        </div>
        <div class="score">${this.analysisResults.overall}/100</div>
        <div style="background: ${this.analysisResults.overall >= 80 ? '#dcfce7' : this.analysisResults.overall >= 60 ? '#fef3c7' : this.analysisResults.overall >= 40 ? '#fed7aa' : '#fecaca'}; color: ${this.analysisResults.overall >= 80 ? '#166534' : this.analysisResults.overall >= 60 ? '#92400e' : this.analysisResults.overall >= 40 ? '#9a3412' : '#991b1b'}; padding: 8px 16px; border-radius: 8px; font-weight: bold; display: inline-block; border: 2px solid ${this.analysisResults.overall >= 80 ? '#16a34a' : this.analysisResults.overall >= 60 ? '#d97706' : this.analysisResults.overall >= 40 ? '#ea580c' : '#dc2626'};">${this.getScoreBadge(this.analysisResults.overall)}</div>
    </div>
    
    <div class="section">
        <h2 style="color: #1f2937; border-bottom: 3px solid #16a34a; padding-bottom: 8px; margin-top: 0; font-size: 1.5em;">🌱 Sostenibilità Ambientale (${this.analysisResults.environmental.score}/100)</h2>
        <div class="metric"><span>CO₂ per visualizzazione:</span><span>${this.analysisResults.environmental.co2Impact}g</span></div>
        <div class="metric"><span>Acqua per visualizzazione:</span><span>${this.analysisResults.environmental.waterImpact}L</span></div>
        <div class="metric"><span>Energia richiesta:</span><span>${this.analysisResults.environmental.energyImpact}kWh</span></div>
        <div class="metric"><span>Standard utilizzati:</span><span>20g CO₂/MB • 0.2L H₂O/MB</span></div>
        <div class="metric"><span>Fonte:</span><span>The Shift Project (2019) • Water Footprint Network</span></div>
        
        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 20px; margin: 20px 0;">
            <h3 style="color: #0c4a6e; margin-top: 0;">📊 Impatto per 1000 Visualizzazioni Web</h3>
            <div class="metric"><span>🌱 CO₂ totale emessa:</span><span>${(this.analysisResults.environmental.co2Impact * 1000).toFixed(1)}g</span></div>
            <div class="metric"><span>🚗 Chilometri in auto:</span><span>${((this.analysisResults.environmental.equivalences.co2.carMeters * 1000) / 1000).toFixed(2)} km</span></div>
            <div class="metric"><span>📱 Ricariche smartphone:</span><span>${(parseFloat(this.analysisResults.environmental.equivalences.energy.phoneCharges) * 1000).toFixed(0)} ricariche</span></div>
            <div class="metric"><span>💧 Consumo acqua totale:</span><span>${(this.analysisResults.environmental.waterImpact * 1000).toFixed(2)} litri</span></div>
        </div>
    </div>
    
    <div class="section">
        <div class="metric"><span>Contrasto medio WCAG:</span><span style="font-weight: bold; color: ${this.analysisResults.accessibility.contrast >= 4.5 ? '#16a34a' : '#dc2626'};">${this.analysisResults.accessibility.contrast}:1</span></div>
        <div class="metric"><span>Contrasto massimo:</span><span style="font-weight: bold; color: ${this.analysisResults.accessibility.maxContrast >= 4.5 ? '#16a34a' : '#dc2626'};">${this.analysisResults.accessibility.maxContrast}:1</span></div>
        <div class="metric"><span>Livello conformità WCAG:</span><span><strong>${this.analysisResults.accessibility.wcagLevel}</strong></span></div>
        <div class="metric"><span>Leggibilità valutata:</span><span>${this.analysisResults.accessibility.readability}</span></div>
        <div class="metric"><span>Coppie colori conformi AA:</span><span>${this.analysisResults.accessibility.aaCompliant}/${this.analysisResults.accessibility.contrastPairs}</span></div>
    </div>
    
    <footer style="text-align: center; margin-top: 40px; padding: 25px; background: #f3f4f6; border-radius: 8px; border: 2px solid #d1d5db;">
        <h3 style="color: #1f2937; margin-top: 0;">🌱 Nova (beta) - Certificato Ufficiale</h3>
        <p style="color: #374151; margin: 10px 0;"><strong>Data generazione:</strong> ${new Date().toLocaleString('it-IT')}</p>
        <p style="color: #6b7280; font-size: 14px; margin-top: 15px;">
            <strong>⚠️ Disclaimer:</strong> NOVA fornisce un'analisi comparativa a fini informativi. I risultati non sostituiscono valutazioni tecniche o specialistiche.
        </p>
    </footer>
</body>
</html>`;
                
                try {
                    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.style.display = 'none';

                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Errore download:', error);
                    this.error = 'Errore durante il download del certificato';
                    this.render();
                }
            }
            
            render() {
                const app = document.getElementById('app');
                
                app.innerHTML = `
                    <div class="max-w-6xl mx-auto p-4">
                        <!-- Header -->
                        <div class="text-center mb-8">
                            <div class="flex items-center justify-center gap-2 mb-4">
                                <i data-lucide="leaf" class="h-8 w-8 text-green-600"></i>
                                <h1 class="text-4xl font-bold text-gray-900">Nova</h1>
                                <span class="bg-gray-200 text-gray-600 text-sm px-2 py-1 rounded-md">beta</span>
                            </div>
                            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                                Assistente AI per valutare la sostenibilità digitale dei tuoi contenuti web
                            </p>
                            <p class="text-sm text-gray-500 mt-2">
                                Standard: 20g CO₂/MB (The Shift Project) • 0.2L H₂O/MB (Water Footprint Network)
                            </p>
                        </div>

                        <!-- Error Display -->
                        ${this.error ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 fade-in">
                            <div class="flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="h-5 w-5 text-red-600"></i>
                                <span class="text-red-800">${this.error}</span>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Upload Area -->
                        ${!this.uploadedImage ? `
                        <div class="bg-white rounded-lg shadow-md mb-8">
                            <div class="p-8">
                                <div id="upload-area" class="border-2 border-dashed rounded-lg p-12 text-center transition-colors border-gray-300 hover:border-green-400 cursor-pointer">
                                    <i data-lucide="upload" class="h-16 w-16 text-gray-400 mx-auto mb-4"></i>
                                    <h3 class="text-xl font-semibold text-gray-700 mb-2">
                                        Carica la tua immagine
                                    </h3>
                                    <p class="text-gray-500 mb-6">
                                        Trascina qui il file oppure clicca per selezionare
                                    </p>
                                    <p class="text-sm text-gray-400 mb-6">
                                        Formati supportati: JPG, PNG, WebP, SVG (max 10MB)
                                    </p>
                                    <input type="file" id="file-upload" class="hidden" accept="image/*" />
                                    <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors" onclick="document.getElementById('file-upload').click()">
                                        Seleziona File
                                    </button>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Image Preview -->
                        ${this.uploadedImage ? `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 fade-in">
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold">Anteprima Immagine</h3>
                                    <p class="text-gray-600">
                                        ${this.uploadedImage.name} • ${(this.uploadedImage.size / (1024*1024)).toFixed(2)} MB • ${this.uploadedImage.type.split('/')[1].toUpperCase()}
                                    </p>
                                </div>
                                <div class="p-6">
                                    <img src="${this.uploadedImage.url}" alt="Uploaded content" class="w-full h-64 object-contain rounded-lg border bg-gray-50" />
                                    <div class="mt-4 flex gap-2">
                                        <button id="analyze-btn" ${this.isAnalyzing ? 'disabled' : ''} class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                            ${this.isAnalyzing ? `
                                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                Analizzando...
                                            ` : `
                                                <i data-lucide="eye" class="h-4 w-4"></i>
                                                Avvia Analisi
                                            `}
                                        </button>
                                        <button id="remove-btn" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                                            Rimuovi
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress -->
                            ${this.isAnalyzing ? `
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold">Analisi in Corso</h3>
                                    <p class="text-gray-600">Elaborazione scientifica in corso...</p>
                                </div>
                                <div class="p-6 space-y-4">
                                    ${[
                                        '🖼️ Caricamento Canvas HTML5', 
                                        '🎨 Analisi colori dominanti', 
                                        '📏 Calcolo contrasti WCAG', 
                                        '🌱 Valutazione CO₂ (20g/MB)',
                                        '💧 Calcolo impatto idrico',
                                        '📊 Generazione score finale'
                                    ].map(step => `
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span>${step}</span>
                                                <span class="text-green-600">✓</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-600 h-2 rounded-full w-full transition-all duration-300"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}

                        <!-- Results -->
                        ${this.analysisResults ? `
                        <div class="space-y-8 fade-in">
                            <!-- Overall Score -->
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-6 text-center">
                                    <h2 class="text-2xl font-bold mb-4">Punteggio complessivo</h2>
                                    <div class="text-6xl font-bold mb-2 ${this.getScoreColor(this.analysisResults.overall)}">
                                        ${this.analysisResults.overall}
                                    </div>
                                    <span class="inline-block text-lg px-4 py-1 rounded-full ${
                                        this.analysisResults.overall >= 80 ? 'bg-green-100 text-green-800' :
                                        this.analysisResults.overall >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                        this.analysisResults.overall >= 40 ? 'bg-orange-100 text-orange-800' :
                                        'bg-red-100 text-red-800'
                                    }">
                                        ${this.getScoreBadge(this.analysisResults.overall)}
                                    </span>
                                    <p class="text-sm text-gray-500 mt-2">
                                        Media pesata: Ambientale (40%) • Accessibilità (35%) • Economica (25%)
                                    </p>
                                </div>
                            </div>

                            <!-- Detailed Scores -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Environmental -->
                                <div class="bg-white rounded-lg shadow-md">
                                    <div class="p-6 border-b">
                                        <h3 class="text-lg font-semibold flex items-center gap-2">
                                            <i data-lucide="leaf" class="h-5 w-5 text-green-600"></i>
                                            Ambientale
                                        </h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="text-3xl font-bold mb-4 ${this.getScoreColor(this.analysisResults.environmental.score)}">
                                            ${this.analysisResults.environmental.score}/100
                                        </div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span>🌱 CO₂ per view:</span>
                                                <span class="font-medium">${this.analysisResults.environmental.co2Impact}g</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>💧 Acqua per view:</span>
                                                <span class="font-medium">${this.analysisResults.environmental.waterImpact}L</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>⚡ Energia per view:</span>
                                                <span class="font-medium">${this.analysisResults.environmental.energyImpact}kWh</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>📁 Dimensione:</span>
                                                <span class="font-medium">${(this.analysisResults.environmental.fileSize / (1024*1024)).toFixed(2)}MB</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Tema:</span>
                                                <span class="px-2 py-1 rounded text-xs ${this.analysisResults.environmental.isDarkTheme ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-800'}">
                                                    ${this.analysisResults.environmental.isDarkTheme ? "Scuro" : "Chiaro"}
                                                </span>
                                            </div>
                                            <div class="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-700">
                                                📊 <strong>Standard:</strong> 20g CO₂/MB • 0.2L H₂O/MB<br/>
                                                <strong>Fonte:</strong> The Shift Project (2019)
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Accessibility -->
                                <div class="bg-white rounded-lg shadow-md">
                                    <div class="p-6 border-b">
                                        <h3 class="text-lg font-semibold flex items-center gap-2">
                                            <i data-lucide="eye" class="h-5 w-5 text-blue-600"></i>
                                            Accessibilità
                                        </h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="text-3xl font-bold mb-4 ${this.getScoreColor(this.analysisResults.accessibility.score)}">
                                            ${this.analysisResults.accessibility.score}/100
                                        </div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span>Contrasto medio:</span>
                                                <span class="font-medium ${this.analysisResults.accessibility.contrast >= 4.5 ? 'text-green-600' : 'text-red-600'}">
                                                    ${this.analysisResults.accessibility.contrast}:1
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Contrasto max:</span>
                                                <span class="font-medium ${this.analysisResults.accessibility.maxContrast >= 4.5 ? 'text-green-600' : 'text-red-600'}">
                                                    ${this.analysisResults.accessibility.maxContrast}:1
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Livello WCAG:</span>
                                                <span class="px-2 py-1 rounded text-xs font-medium ${
                                                    this.analysisResults.accessibility.wcagLevel === 'AAA' ? 'bg-green-100 text-green-800' :
                                                    this.analysisResults.accessibility.wcagLevel === 'AA' ? 'bg-blue-100 text-blue-800' :
                                                    this.analysisResults.accessibility.wcagLevel === 'A' ? 'bg-yellow-100 text-yellow-800' :
                                                    'bg-red-100 text-red-800'
                                                }">
                                                    ${this.analysisResults.accessibility.wcagLevel}
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Coppie AA:</span>
                                                <span>${this.analysisResults.accessibility.aaCompliant}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Economic -->
                                <div class="bg-white rounded-lg shadow-md">
                                    <div class="p-6 border-b">
                                        <h3 class="text-lg font-semibold flex items-center gap-2">
                                            <i data-lucide="dollar-sign" class="h-5 w-5 text-purple-600"></i>
                                            Economica
                                        </h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="text-3xl font-bold mb-4 ${this.getScoreColor(this.analysisResults.economic.score)}">
                                            ${this.analysisResults.economic.score}/100
                                        </div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span>Tipo font:</span>
                                                <span class="capitalize">${this.analysisResults.economic.fontType}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Licenza:</span>
                                                <span class="text-xs">${this.analysisResults.economic.licensing}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Efficienza:</span>
                                                <span>${this.analysisResults.economic.efficiency}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Environmental Impact Details -->
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold flex items-center gap-2">
                                        🌍 Impatto ambientale
                                    </h3>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <h4 class="font-semibold text-green-800 mb-3">Per 1 Visualizzazione</h4>
                                            <div class="space-y-2 text-sm">
                                                <div class="flex justify-between">
                                                    <span>CO₂ emessa:</span>
                                                    <span class="font-medium">${this.analysisResults.environmental.co2Impact}g</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Acqua utilizzata:</span>
                                                    <span class="font-medium">${this.analysisResults.environmental.waterImpact}L</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Energia consumata:</span>
                                                    <span class="font-medium">${this.analysisResults.environmental.energyImpact}kWh</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <h4 class="font-semibold text-blue-800 mb-3">Per 1000 Visualizzazioni</h4>
                                            <div class="space-y-2 text-sm">
                                                <div class="flex justify-between">
                                                    <span>🌱 CO₂ totale:</span>
                                                    <span class="font-medium">${(this.analysisResults.environmental.co2Impact * 1000).toFixed(1)}g</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>🚗 Chilometri auto:</span>
                                                    <span class="font-medium">${((this.analysisResults.environmental.equivalences.co2.carMeters * 1000) / 1000).toFixed(2)}km</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>📱 Ricariche smartphone:</span>
                                                    <span class="font-medium">${(parseFloat(this.analysisResults.environmental.equivalences.energy.phoneCharges) * 1000).toFixed(0)}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>💧 Litri acqua:</span>
                                                    <span class="font-medium">${(this.analysisResults.environmental.waterImpact * 1000).toFixed(2)}L</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Color Palette -->
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold flex items-center gap-2">
                                        🎨 Colori Dominanti
                                    </h3>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        ${this.analysisResults.metadata.dominantColors?.map(color => `
                                            <div class="text-center">
                                                <div class="w-full h-16 rounded-lg border-2 border-gray-200 mb-2 shadow-sm" style="background-color: ${color.hex}"></div>
                                                <div class="text-xs font-mono font-bold">${color.hex}</div>
                                                <div class="text-xs text-gray-500">${color.percentage}%</div>
                                            </div>
                                        `).join('') || ''}
                                    </div>
                                </div>
                            </div>

                            <!-- Certificate Download -->
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold flex items-center gap-2">
                                        <i data-lucide="award" class="h-5 w-5 text-yellow-600"></i>
                                        Certificato di Sostenibilità
                                    </h3>
                                </div>
                                <div class="p-6">
                                    <div class="flex flex-col sm:flex-row gap-4 items-start">
                                        <button id="download-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                            <i data-lucide="download" class="h-4 w-4"></i>
                                            Scarica Certificato HTML
                                        </button>
                                        <div class="text-sm text-gray-500">
                                            <p class="mb-1">📄 Include analisi completa e metodologia</p>
                                            <p>💡 Per PDF: Apri HTML e stampa (Ctrl+P → Salva come PDF)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Footer -->
                    <footer class="mt-16 text-center text-gray-500 text-sm no-print">
                        <div class="max-w-4xl mx-auto px-4 py-8 border-t border-gray-200">
                            <div class="flex items-center justify-center gap-2 mb-4">
                                <i data-lucide="leaf" class="h-4 w-4 text-green-600"></i>
                                <span class="font-semibold">Nova (beta)</span>
                            </div>
                            <p class="mb-2">
                                Assistente AI per la valutazione scientifica della sostenibilità digitale
                            </p>
                            <p class="text-xs mb-4">
                                Standard: WCAG 2.1 • The Shift Project (2019) • Water Footprint Network
                            </p>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-xs">
                                <div class="flex flex-col items-center gap-1">
                                    <span class="font-medium">🔬 Canvas</span>
                                    <span>HTML5 Analysis</span>
                                </div>
                                <div class="flex flex-col items-center gap-1">
                                    <span class="font-medium">🎨 WCAG</span>
                                    <span>2.1 Standards</span>
                                </div>
                                <div class="flex flex-col items-center gap-1">
                                    <span class="font-medium">🌱 CO₂</span>
                                    <span>20g/MB</span>
                                </div>
                                <div class="flex flex-col items-center gap-1">
                                    <span class="font-medium">💧 H₂O</span>
                                    <span>0.2L/MB</span>
                                </div>
                                <div class="flex flex-col items-center gap-1">
                                    <span class="font-medium">📊 Nova</span>
                                    <span>(beta)</span>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <p class="text-xs text-gray-400">
                                    ⚠️ NOVA fornisce un'analisi comparativa a fini informativi. I risultati non sostituiscono valutazioni tecniche o specialistiche.
                                </p>
                            </div>
                        </div>
                    </footer>
                `;
                
                // Re-initialize icons and event listeners after render
                setTimeout(() => {
                    this.initializeLucideIcons();
                    this.attachEventListeners();
                }, 100);
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new NovaSustainabilityAnalyzer();
        });
    </script>
</body>
</html>

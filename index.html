<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova (beta) - Sostenibilità Digitale</title>
    <meta name="description" content="Assistente AI per valutare la sostenibilità digitale dei contenuti web">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons via CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* Custom color palette using CSS variables */
        :root {
            --bg-primary: #1F3B2C;
            --bg-secondary: #FFFFFF;
            --text-primary: #96E6B3;
            --text-secondary: #FFFFFF;
            --accent: #96E6B3;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
        }
        
        .bg-custom-primary { background-color: var(--bg-primary); }
        .bg-custom-secondary { background-color: var(--bg-secondary); }
        .text-custom-primary { color: var(--text-primary); }
        .text-custom-secondary { color: var(--text-secondary); }
        .border-custom-accent { border-color: var(--accent); }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: var(--bg-secondary);
            color: #1f2937;
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }
        
        .info-icon {
            cursor: pointer;
            color: var(--accent);
            margin-left: 8px;
            font-size: 14px;
        }
        
        .info-icon:hover {
            opacity: 0.7;
        }
        
        /* Custom styles for animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .drag-active {
            border-color: var(--accent) !important;
            background-color: rgba(150, 230, 179, 0.1) !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card styles with glass effect */
        .card-dark {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(150, 230, 179, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .card-light {
            background-color: var(--bg-secondary);
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
        }
        
        /* Button styles */
        .btn-primary {
            background-color: var(--accent);
            color: var(--bg-primary);
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: rgba(150, 230, 179, 0.8);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            border: 1px solid var(--accent);
            color: var(--accent);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: rgba(150, 230, 179, 0.1);
        }
        
        /* Link styles */
        .external-link {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .external-link:hover {
            color: #1d4ed8;
        }
        
        /* Score colors */
        .score-excellent { color: var(--accent); }
        .score-good { color: #facc15; }
        .score-fair { color: #fb923c; }
        .score-poor { color: #f87171; }
        
        /* Badge styles */
        .badge-excellent { background-color: rgba(150, 230, 179, 0.2); color: var(--accent); }
        .badge-good { background-color: rgba(250, 204, 21, 0.2); color: #facc15; }
        .badge-fair { background-color: rgba(251, 146, 60, 0.2); color: #fb923c; }
        .badge-poor { background-color: rgba(248, 113, 113, 0.2); color: #f87171; }
    </style>
</head>
<body class="min-h-screen bg-custom-primary">
    <!-- Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="app"></div>

    <script>
        // Nova Sustainability Analyzer - Updated Version
        class NovaSustainabilityAnalyzer {
            constructor() {
                this.uploadedImage = null;
                this.analysisResults = null;
                this.isAnalyzing = false;
                this.dragActive = false;
                this.error = null;
                
                this.init();
            }
            
            init() {
                this.render();
                this.attachEventListeners();
                this.initializeLucideIcons();
                this.setupModal();
            }
            
            setupModal() {
                const modal = document.getElementById('infoModal');
                const closeBtn = document.querySelector('.close');
                
                closeBtn.onclick = () => {
                    modal.classList.remove('show');
                };
                
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.classList.remove('show');
                    }
                };
            }
            
            showInfoModal(title, content) {
                const modal = document.getElementById('infoModal');
                const modalContent = document.getElementById('modalContent');
                
                modalContent.innerHTML = `
                    <h2 style="color: #1f2937; font-size: 1.5em; font-weight: bold; margin-bottom: 16px;">${title}</h2>
                    <div style="line-height: 1.6;">${content}</div>
                `;
                
                modal.classList.add('show');
            }
            
            initializeLucideIcons() {
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            attachEventListeners() {
                // File upload events
                const fileInput = document.getElementById('file-upload');
                const uploadArea = document.getElementById('upload-area');
                const analyzeBtn = document.getElementById('analyze-btn');
                const removeBtn = document.getElementById('remove-btn');
                const downloadBtn = document.getElementById('download-btn');
                
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileInput(e));
                }
                
                if (uploadArea) {
                    uploadArea.addEventListener('dragenter', (e) => this.handleDrag(e));
                    uploadArea.addEventListener('dragover', (e) => this.handleDrag(e));
                    uploadArea.addEventListener('dragleave', (e) => this.handleDrag(e));
                    uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
                }
                
                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', () => this.analyzeImage());
                }
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => this.removeImage());
                }
                
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => this.downloadCertificate());
                }
                
                // Info icon events
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('info-icon')) {
                        const infoType = e.target.dataset.info;
                        this.showInfoForType(infoType);
                    }
                });
            }
            
            showInfoForType(type) {
                const infoContent = {
                    'co2_upload': {
                        title: '📦 CO₂ per Upload',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            Caricare un contenuto digitale consuma energia nei server, nella rete e nei dispositivi. Questa energia, in media, genera circa <strong>0.072 grammi di CO₂ per ogni megabyte trasferito</strong>.</p>
                            
                            <p><strong>Formula utilizzata:</strong><br>
                            <code>CO₂_upload (g) = MB × 0.072</code></p>
                            
                            <p><strong>Fonte:</strong><br>
                            <a href="https://sustainablewebdesign.org/estimating-digital-emissions/" target="_blank" class="external-link">Sustainable Web Design – Estimating Digital Emissions</a></p>
                        `
                    },
                    'water_upload': {
                        title: '💧 Acqua per Upload',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            I data center usano acqua per raffreddare i server. A seconda della tecnologia e del paese, ogni MB trasferito può usare da <strong>1 a 205 millilitri d'acqua</strong>.</p>
                            
                            <p><strong>Formula utilizzata:</strong><br>
                            <code>H₂O_upload (ml) = MB × W</code><br>
                            (dove W ∈ [1, 205])</p>
                            
                            <p><strong>Fonti:</strong><br>
                            • <a href="https://www.mdpi.com/2071-1050/7/8/11260" target="_blank" class="external-link">MDPI Study</a><br>
                            • <a href="https://www.researchgate.net/publication/281719759" target="_blank" class="external-link">ResearchGate Publication</a><br>
                            • <a href="https://watercalculator.org/footprint/data-centers-water-use/" target="_blank" class="external-link">WaterCalculator.org</a></p>
                        `
                    },
                    'co2_view': {
                        title: '⏱️ CO₂ per Visualizzazione',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            Ogni minuto in cui un utente visualizza un contenuto online consuma energia per alimentare lo schermo, la rete e i server. In media, ciò produce <strong>6 grammi di CO₂ per minuto di visualizzazione</strong>.</p>
                            
                            <p><strong>Formula utilizzata:</strong><br>
                            <code>CO₂_view (g) = minuti × 6</code></p>
                            
                            <p><strong>Fonti:</strong><br>
                            • <a href="https://www.iea.org/commentaries/the-carbon-footprint-of-streaming-video" target="_blank" class="external-link">IEA Carbon Footprint Study</a><br>
                            • <a href="https://www.cloudzero.com/blog/tech-carbon-footprint/" target="_blank" class="external-link">CloudZero Carbon Footprint Analysis</a></p>
                        `
                    },
                    'color_impact': {
                        title: '🎨 Impatto Colori',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            I display OLED consumano più energia per mostrare colori chiari e accesi. Ad esempio, il bianco consuma fino a 3 volte più energia del nero. Questo impatta direttamente l'impronta di carbonio della visualizzazione.</p>
                            
                            <p><strong>Formula utilizzata:</strong><br>
                            <code>CO₂_view_color (g) = CO₂_view × (1 + color_factor)</code><br>
                            • Palette scura: +0%<br>
                            • Colori accesi/blu: +25%<br>
                            • Bianco/neon: +40%</p>
                            
                            <p><strong>Fonti:</strong><br>
                            • <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8876531/" target="_blank" class="external-link">PMC Study on OLED</a><br>
                            • <a href="https://sustainablewebdesign.org/has-the-color-palette-prioritized-colors-that-used-less-energy-on-oled-screens/" target="_blank" class="external-link">Sustainable Web Design</a></p>
                        `
                    },
                    'contrast_wcag': {
                        title: '📖 Contrasto WCAG',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            Il contrasto tra il testo e lo sfondo deve essere sufficientemente elevato per garantire la leggibilità anche a persone con disabilità visive. Le WCAG stabiliscono che il rapporto minimo deve essere 4.5:1 per il testo normale.</p>
                            
                            <p><strong>Formula utilizzata:</strong><br>
                            <code>Contrast Ratio = (L1 + 0.05) / (L2 + 0.05)</code><br>
                            dove L1 e L2 sono le luminosità relative dei colori</p>
                            
                            <p><strong>Standard:</strong><br>
                            • ≥ 4.5:1 per testi normali (AA)<br>
                            • ≥ 3:1 per testi grandi (≥ 18pt bold)</p>
                            
                            <p><strong>Fonte:</strong><br>
                            <a href="https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum/" target="_blank" class="external-link">WCAG 2.1 Guideline 1.4.3</a></p>
                        `
                    },
                    'alt_text': {
                        title: '🖼️ Testo Alternativo',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            Ogni immagine dovrebbe includere un testo descrittivo che spieghi il contenuto visivo a chi non può vederlo. L'attributo <code>alt</code> è fondamentale per utenti non vedenti che usano screen reader.</p>
                            
                            <p><strong>Valutazione:</strong><br>
                            L'analisi verifica se il contenuto include descrizioni testuali adeguate per elementi grafici.</p>
                            
                            <p><strong>Fonte:</strong><br>
                            <a href="https://www.w3.org/WAI/WCAG21/Understanding/non-text-content/" target="_blank" class="external-link">WCAG 2.1 Guideline 1.1.1</a></p>
                        `
                    },
                    'design_system': {
                        title: '🎨 Design System',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            Se il contenuto usa componenti di un design system o libreria visiva standard, sarà più veloce da modificare, sviluppare e replicare. Un'interfaccia costruita con elementi riutilizzabili è <strong>più economica</strong> e sostenibile nel tempo.</p>
                            
                            <p><strong>Valutazione:</strong><br>
                            • Componenti da librerie standard<br>
                            • Uso di spacing coerente<br>
                            • Ripetizione efficiente degli elementi</p>
                            
                            <p><strong>Riferimenti:</strong><br>
                            • <a href="https://material.io/design" target="_blank" class="external-link">Material Design</a><br>
                            • <a href="https://www.ibm.com/design/language/" target="_blank" class="external-link">IBM Design Language</a></p>
                        `
                    },
                    'open_fonts': {
                        title: '📝 Font Open Source',
                        content: `
                            <p><strong>Cosa significa:</strong><br>
                            I font open source eliminano costi di licenza, sono compatibili cross-platform e leggeri da caricare. L'uso di font proprietari, invece, può comportare costi elevati, limiti di utilizzo e maggiore peso del file.</p>
                            
                            <p><strong>Valutazione:</strong><br>
                            • Presenza di font gratuiti vs licenziati<br>
                            • Assenza di font rasterizzati<br>
                            • Peso e compatibilità</p>
                            
                            <p><strong>Riferimento:</strong><br>
                            <a href="https://fonts.google.com/" target="_blank" class="external-link">Google Fonts (Elenco font open)</a></p>
                        `
                    }
                };
                
                const info = infoContent[type];
                if (info) {
                    this.showInfoModal(info.title, info.content);
                }
            }
            
            handleDrag(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const uploadArea = document.getElementById('upload-area');
                if (e.type === "dragenter" || e.type === "dragover") {
                    this.dragActive = true;
                    uploadArea?.classList.add('drag-active');
                } else if (e.type === "dragleave") {
                    this.dragActive = false;
                    uploadArea?.classList.remove('drag-active');
                }
            }
            
            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const uploadArea = document.getElementById('upload-area');
                uploadArea?.classList.remove('drag-active');
                this.dragActive = false;
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    this.handleFile(e.dataTransfer.files[0]);
                }
            }
            
            handleFileInput(e) {
                if (e.target.files && e.target.files[0]) {
                    this.handleFile(e.target.files[0]);
                }
            }
            
            handleFile(file) {
                this.error = null;
                
                const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml'];
                if (!validTypes.includes(file.type)) {
                    this.error = 'Formato file non supportato. Usa JPG, PNG, WebP o SVG.';
                    this.render();
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    this.error = 'File troppo grande. Dimensione massima: 10MB.';
                    this.render();
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.uploadedImage = {
                        file: file,
                        url: e.target.result,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    };
                    this.analysisResults = null;
                    this.render();
                };
                reader.onerror = () => {
                    this.error = 'Errore durante la lettura del file.';
                    this.render();
                };
                reader.readAsDataURL(file);
            }
            
            removeImage() {
                this.uploadedImage = null;
                this.analysisResults = null;
                this.error = null;
                this.render();
            }
            
            async loadImageToCanvas(imageUrl) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            const maxSize = 800;
                            const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            resolve({
                                canvas,
                                ctx,
                                imageData,
                                originalWidth: img.width,
                                originalHeight: img.height,
                                scaleFactor: scale
                            });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = () => reject(new Error('Impossibile caricare l\'immagine'));
                    img.src = imageUrl;
                });
            }
            
            analyzeColors(imageData) {
                const data = imageData.data;
                const colors = new Map();
                const pixels = data.length / 4;
                let validPixels = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const a = data[i + 3];
                    
                    if (a < 128) continue;
                    validPixels++;
                    
                    const rGroup = Math.floor(r / 16) * 16;
                    const gGroup = Math.floor(g / 16) * 16;
                    const bGroup = Math.floor(b / 16) * 16;
                    
                    const colorKey = `${rGroup},${gGroup},${bGroup}`;
                    colors.set(colorKey, (colors.get(colorKey) || 0) + 1);
                }
                
                const sortedColors = Array.from(colors.entries())
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10)
                    .map(([color, count]) => {
                        const [r, g, b] = color.split(',').map(Number);
                        return {
                            rgb: { r, g, b },
                            hex: `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`,
                            count,
                            percentage: validPixels > 0 ? (count / validPixels * 100).toFixed(2) : 0
                        };
                    });

                const avgBrightness = sortedColors.reduce((sum, color) => {
                    const luminance = 0.2126 * color.rgb.r + 0.7152 * color.rgb.g + 0.0722 * color.rgb.b;
                    return sum + luminance * parseFloat(color.percentage);
                }, 0) / 100;

                return {
                    dominantColors: sortedColors,
                    isDarkTheme: avgBrightness < 128,
                    averageBrightness: Math.round(avgBrightness),
                    totalValidPixels: validPixels
                };
            }
            
            calculateWCAGContrast(color1, color2) {
                const getLuminance = (r, g, b) => {
                    const [rs, gs, bs] = [r, g, b].map(c => {
                        c = c / 255;
                        return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
                    });
                    return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
                };

                const l1 = getLuminance(color1.r, color1.g, color1.b);
                const l2 = getLuminance(color2.r, color2.g, color2.b);
                
                const lighter = Math.max(l1, l2);
                const darker = Math.min(l1, l2);
                
                return (lighter + 0.05) / (darker + 0.05);
            }
            
            // Updated environmental impact calculation with new formulas
            calculateEnvironmentalImpact(image, colorAnalysis) {
                const sizeInMB = image.size / (1024 * 1024);
                
                // New realistic formulas
                const co2Upload = sizeInMB * 0.072; // 0.072g CO2 per MB for upload
                const waterUpload = sizeInMB * 103; // Average 103ml (middle of 1-205ml range)
                
                // Viewing time estimation (assume 1 minute for images)
                const viewingMinutes = 1;
                const co2BaseView = viewingMinutes * 6; // 6g CO2 per minute
                
                // Color impact adjustment
                let colorFactor = 0;
                if (colorAnalysis.averageBrightness > 200) {
                    colorFactor = 0.4; // White/neon content
                } else if (colorAnalysis.averageBrightness > 150 || !colorAnalysis.isDarkTheme) {
                    colorFactor = 0.25; // Bright colors/blue
                } else {
                    colorFactor = 0; // Dark palette
                }
                
                const co2ViewWithColor = co2BaseView * (1 + colorFactor);
                
                // Total CO2 impact
                const totalCO2 = co2Upload + co2ViewWithColor;
                
                // Calculate score based on efficiency
                const optimalSizeMB = 0.15;
                const sizeRatio = sizeInMB / optimalSizeMB;
                let score = Math.max(0, 100 - (sizeRatio - 1) * 30);
                
                // Adjust for format efficiency
                if (image.type === 'image/webp') score += 15;
                else if (image.type === 'image/svg+xml') score += 20;
                else if (image.type === 'image/png' && sizeInMB > 0.2) score -= 10;
                
                // Adjust for color efficiency
                if (colorAnalysis.isDarkTheme) score += 10;
                else if (colorAnalysis.averageBrightness > 200) score -= 15;
                
                score = Math.max(0, Math.min(100, score));
                
                const recommendations = [];
                if (sizeInMB > 0.5) recommendations.push("Riduci dimensioni file: obiettivo <500KB");
                if (image.type !== 'image/webp' && sizeInMB > 0.1) recommendations.push("Considera WebP per -30% dimensioni");
                if (!colorAnalysis.isDarkTheme && colorAnalysis.averageBrightness > 180) recommendations.push("Palette più scura per dispositivi OLED");
                
                return {
                    co2Upload: parseFloat(co2Upload.toFixed(3)),
                    waterUpload: parseFloat(waterUpload.toFixed(2)),
                    co2View: parseFloat(co2ViewWithColor.toFixed(2)),
                    totalCO2: parseFloat(totalCO2.toFixed(2)),
                    colorFactor: colorFactor,
                    score: Math.round(score),
                    recommendations,
                    viewingMinutes
                };
            }
            
            analyzeAccessibility(colorAnalysis) {
                const colors = colorAnalysis.dominantColors;
                const contrasts = [];
                
                // Calculate contrasts between significant colors
                const significantColors = colors.filter(color => parseFloat(color.percentage) > 2);
                
                for (let i = 0; i < Math.min(significantColors.length, 5); i++) {
                    for (let j = i + 1; j < Math.min(significantColors.length, 5); j++) {
                        const contrast = this.calculateWCAGContrast(significantColors[i].rgb, significantColors[j].rgb);
                        contrasts.push({
                            color1: significantColors[i],
                            color2: significantColors[j],
                            ratio: contrast,
                            wcagAA: contrast >= 4.5,
                            wcagAAA: contrast >= 7.0
                        });
                    }
                }
                
                const bestContrast = contrasts.length > 0 ? Math.max(...contrasts.map(c => c.ratio)) : 1;
                const avgContrast = contrasts.length > 0 ? 
                    contrasts.reduce((sum, c) => sum + c.ratio, 0) / contrasts.length : 1;
                
                const aaCompliant = contrasts.filter(c => c.wcagAA).length;
                const totalPairs = contrasts.length;
                
                // Accessibility score
                let accessibilityScore = 0;
                if (bestContrast >= 7.0) {
                    accessibilityScore = 90 + Math.min(10, (bestContrast - 7) * 2);
                } else if (bestContrast >= 4.5) {
                    accessibilityScore = 70 + Math.min(20, (bestContrast - 4.5) * 8);
                } else if (bestContrast >= 3.0) {
                    accessibilityScore = 40 + Math.min(30, (bestContrast - 3.0) * 20);
                } else {
                    accessibilityScore = Math.min(40, bestContrast * 10);
                }
                
                // Alt text check (simplified - in real scenario would analyze metadata)
                const hasAltText = false; // Simplified assumption
                
                // Text in images check (simplified)
                const hasTextInImages = false; // Simplified assumption
                
                return {
                    contrastRatio: parseFloat(bestContrast.toFixed(2)),
                    averageContrast: parseFloat(avgContrast.toFixed(2)),
                    wcagLevel: bestContrast >= 7.0 ? 'AAA' : bestContrast >= 4.5 ? 'AA' : bestContrast >= 3.0 ? 'A' : 'Fail',
                    score: Math.round(accessibilityScore),
                    aaCompliant,
                    totalPairs,
                    hasAltText,
                    hasTextInImages,
                    contrasts: contrasts.slice(0, 3)
                };
            }
            
            analyzeEconomicSustainability(image, colorAnalysis) {
                // Simplified economic analysis
                let score = 70; // Base score
                
                // Font analysis (simplified - would need OCR in real implementation)
                const fontType = 'system'; // Simplified assumption
                const isOpenSource = true; // Simplified assumption
                
                // Layout analysis based on color distribution
                const colorVariety = colorAnalysis.dominantColors.length;
                const isSimpleLayout = colorVariety <= 5;
                
                // Design system analysis (simplified)
                const usesDesignSystem = isSimpleLayout && colorAnalysis.isDarkTheme;
                
                if (isOpenSource) score += 15;
                if (isSimpleLayout) score += 10;
                if (usesDesignSystem) score += 5;
                
                // File format efficiency
                if (image.type === 'image/svg+xml') score += 20;
                else if (image.type === 'image/webp') score += 10;
                
                score = Math.max(0, Math.min(100, score));
                
                return {
                    score: Math.round(score),
                    fontType,
                    isOpenSource,
                    usesDesignSystem,
                    isSimpleLayout,
                    recommendations: []
                };
            }
            
            async analyzeImage() {
                if (!this.uploadedImage) {
                    this.error = 'Nessuna immagine caricata';
                    this.render();
                    return;
                }
                
                this.isAnalyzing = true;
                this.error = null;
                this.render();
                
                try {
                    const { canvas, ctx, imageData, originalWidth, originalHeight, scaleFactor } = await this.loadImageToCanvas(this.uploadedImage.url);
                    
                    const colorAnalysis = this.analyzeColors(imageData);
                    const environmentalImpact = this.calculateEnvironmentalImpact(this.uploadedImage, colorAnalysis);
                    const accessibilityAnalysis = this.analyzeAccessibility(colorAnalysis);
                    const economicAnalysis = this.analyzeEconomicSustainability(this.uploadedImage, colorAnalysis);
                    
                    // Calculate overall score with updated weights
                    const weights = {
                        environmental: 0.4,
                        accessibility: 0.35,
                        economic: 0.25
                    };
                    
                    const overallScore = Math.round(
                        (environmentalImpact.score * weights.environmental + 
                         accessibilityAnalysis.score * weights.accessibility + 
                         economicAnalysis.score * weights.economic)
                    );
                    
                    this.analysisResults = {
                        environmental: environmentalImpact,
                        accessibility: accessibilityAnalysis,
                        economic: economicAnalysis,
                        overall: overallScore,
                        metadata: {
                            dominantColors: colorAnalysis.dominantColors.slice(0, 5),
                            analysisTimestamp: new Date().toISOString(),
                            imageSize: {
                                width: canvas.width,
                                height: canvas.height,
                                originalWidth,
                                originalHeight,
                                aspectRatio: parseFloat((originalWidth / originalHeight).toFixed(2))
                            },
                            validPixels: colorAnalysis.totalValidPixels,
                            isDarkTheme: colorAnalysis.isDarkTheme,
                            averageBrightness: colorAnalysis.averageBrightness
                        }
                    };
                    
                } catch (error) {
                    console.error('Errore durante analisi:', error);
                    this.error = 'Errore durante analisi: ' + error.message;
                }
                
                this.isAnalyzing = false;
                this.render();
            }
            
            getScoreColor(score) {
                if (score >= 80) return 'score-excellent';
                if (score >= 60) return 'score-good';
                if (score >= 40) return 'score-fair';
                return 'score-poor';
            }
            
            getScoreBadge(score) {
                if (score >= 80) return 'Eccellente';
                if (score >= 60) return 'Buono';
                if (score >= 40) return 'Sufficiente';
                return 'Da migliorare';
            }
            
            getBadgeClass(score) {
                if (score >= 80) return 'badge-excellent';
                if (score >= 60) return 'badge-good';
                if (score >= 40) return 'badge-fair';
                return 'badge-poor';
            }
            
            getAccessibilityStatus(wcagLevel) {
                if (wcagLevel === 'AAA') return '✅ Eccellente';
                if (wcagLevel === 'AA') return '✅ Accessibile';
                if (wcagLevel === 'A') return '⚠️ Parziale';
                return '❌ Non accessibile';
            }
            
            getEconomicStatus(score) {
                if (score >= 80) return '✅ Ottima';
                if (score >= 60) return '⚠️ Parziale';
                return '❌ Bassa';
            }
            
            downloadCertificate() {
                if (!this.analysisResults || !this.uploadedImage) {
                    this.error = 'Nessuna analisi disponibile per il certificato';
                    this.render();
                    return;
                }
                
                const fileName = `certificato-sostenibilita-${this.uploadedImage.name.replace(/\.[^/.]+$/, "")}.html`;
                
                const html = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificato Sostenibilità Digitale - ${this.uploadedImage.name}</title>
    <style>
        body { font-family: 'Arial', sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; color: #1f2937; background: #f8fafc; }
        .header { text-align: center; background: #1F3B2C; color: #96E6B3; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { color: #96E6B3; margin: 0 0 15px 0; font-size: 2.2em; }
        .score { font-size: 4em; font-weight: bold; color: ${this.analysisResults.overall >= 80 ? '#96E6B3' : this.analysisResults.overall >= 60 ? '#facc15' : this.analysisResults.overall >= 40 ? '#fb923c' : '#f87171'}; margin: 20px 0; }
        .section { margin: 20px 0; padding: 25px; border: 2px solid #e5e7eb; border-radius: 8px; background: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .metric { display: flex; justify-content: space-between; margin: 12px 0; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .impact-box { background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 20px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌱 Nova (beta) - Certificato Sostenibilità Digitale</h1>
        <div style="margin: 15px 0; color: #96E6B3;">
            <strong>File:</strong> ${this.uploadedImage.name}<br>
            <strong>Dimensione:</strong> ${(this.uploadedImage.size / (1024*1024)).toFixed(2)} MB<br>
            <strong>Data analisi:</strong> ${new Date().toLocaleDateString('it-IT')}
        </div>
        <div class="score">${this.analysisResults.overall}/100</div>
        <div style="background: ${this.analysisResults.overall >= 80 ? '#96E6B3' : this.analysisResults.overall >= 60 ? '#fef3c7' : this.analysisResults.overall >= 40 ? '#fed7aa' : '#fecaca'}; color: ${this.analysisResults.overall >= 80 ? '#1F3B2C' : this.analysisResults.overall >= 60 ? '#92400e' : this.analysisResults.overall >= 40 ? '#9a3412' : '#991b1b'}; padding: 8px 16px; border-radius: 8px; font-weight: bold; display: inline-block;">${this.getScoreBadge(this.analysisResults.overall)}</div>
    </div>
    
    <div class="section">
        <h2 style="color: #1F3B2C; border-bottom: 3px solid #96E6B3; padding-bottom: 8px; margin-top: 0;">🌱 Sostenibilità Ambientale (${this.analysisResults.environmental.score}/100)</h2>
        <div class="metric"><span>📦 CO₂ per upload:</span><span>${this.analysisResults.environmental.co2Upload}g</span></div>
        <div class="metric"><span>💧 Acqua per upload:</span><span>${this.analysisResults.environmental.waterUpload}ml</span></div>
        <div class="metric"><span>⏱️ CO₂ per visualizzazione:</span><span>${this.analysisResults.environmental.co2View}g</span></div>
        <div class="metric"><span>🌍 CO₂ totale:</span><span>${this.analysisResults.environmental.totalCO2}g</span></div>
        <div class="metric"><span>🎨 Fattore colore:</span><span>+${(this.analysisResults.environmental.colorFactor * 100).toFixed(0)}%</span></div>
        
        <div class="impact-box">
            <h3 style="color: #0c4a6e; margin-top: 0;">📊 Formule Utilizzate (Standard Aggiornati)</h3>
            <div class="metric"><span>📦 Upload:</span><span>MB × 0.072g CO₂</span></div>
            <div class="metric"><span>💧 Raffreddamento:</span><span>MB × 103ml H₂O</span></div>
            <div class="metric"><span>⏱️ Visualizzazione:</span><span>minuti × 6g CO₂</span></div>
            <div class="metric"><span>🎨 Impatto colori:</span><span>Base × (1 + fattore)</span></div>
        </div>
    </div>
    
    <div class="section">
        <h2 style="color: #1F3B2C; border-bottom: 3px solid #96E6B3; padding-bottom: 8px; margin-top: 0;">📖 Accessibilità WCAG 2.1 (${this.analysisResults.accessibility.score}/100)</h2>
        <div class="metric"><span>Contrasto massimo:</span><span style="font-weight: bold; color: ${this.analysisResults.accessibility.contrastRatio >= 4.5 ? '#16a34a' : '#dc2626'};">${this.analysisResults.accessibility.contrastRatio}:1</span></div>
        <div class="metric"><span>Livello WCAG:</span><span><strong>${this.analysisResults.accessibility.wcagLevel}</strong></span></div>
        <div class="metric"><span>Coppie conformi AA:</span><span>${this.analysisResults.accessibility.aaCompliant}/${this.analysisResults.accessibility.totalPairs}</span></div>
        <div class="metric"><span>Status:</span><span>${this.getAccessibilityStatus(this.analysisResults.accessibility.wcagLevel)}</span></div>
    </div>
    
    <div class="section">
        <h2 style="color: #1F3B2C; border-bottom: 3px solid #96E6B3; padding-bottom: 8px; margin-top: 0;">💰 Sostenibilità Economica (${this.analysisResults.economic.score}/100)</h2>
        <div class="metric"><span>Tipo font:</span><span>${this.analysisResults.economic.fontType}</span></div>
        <div class="metric"><span>Font open source:</span><span>${this.analysisResults.economic.isOpenSource ? '✅ Sì' : '❌ No'}</span></div>
        <div class="metric"><span>Design system:</span><span>${this.analysisResults.economic.usesDesignSystem ? '✅ Rilevato' : '⚠️ Non rilevato'}</span></div>
        <div class="metric"><span>Layout semplice:</span><span>${this.analysisResults.economic.isSimpleLayout ? '✅ Sì' : '❌ Complesso'}</span></div>
        <div class="metric"><span>Status:</span><span>${this.getEconomicStatus(this.analysisResults.economic.score)}</span></div>
    </div>
    
    <footer style="text-align: center; margin-top: 40px; padding: 25px; background: #1F3B2C; color: #96E6B3; border-radius: 8px;">
        <h3 style="color: #96E6B3; margin-top: 0;">🌱 Nova (beta) - Certificato Ufficiale</h3>
        <p style="margin: 10px 0;"><strong>Data generazione:</strong> ${new Date().toLocaleString('it-IT')}</p>
        <p style="color: #96E6B3; font-size: 14px; margin-top: 15px;">
            <strong>📊 Standard:</strong> SWD 0.072g CO₂/MB • 103ml H₂O/MB • WCAG 2.1 • 6g CO₂/min view
        </p>
    </footer>
</body>
</html>`;
                
                try {
                    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.style.display = 'none';

                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Errore download:', error);
                    this.error = 'Errore durante il download del certificato';
                    this.render();
                }
            }
            
            render() {
                const app = document.getElementById('app');
                
                app.innerHTML = `
                    <div class="max-w-6xl mx-auto p-4">
                        <!-- Header -->
                        <div class="text-center mb-8">
                            <div class="flex items-center justify-center gap-2 mb-4">
                                <i data-lucide="leaf" class="h-8 w-8 text-custom-primary"></i>
                                <h1 class="text-4xl font-bold text-custom-secondary">Nova</h1>
                                <span class="bg-gray-700 text-custom-primary text-sm px-2 py-1 rounded-md">beta</span>
                            </div>
                            <p class="text-xl text-custom-secondary max-w-2xl mx-auto">
                                Assistente AI per valutare la sostenibilità digitale dei tuoi contenuti web
                            </p>
                            <p class="text-sm text-custom-primary mt-2">
                                Standard aggiornati: 0.072g CO₂/MB upload • 6g CO₂/min view • WCAG 2.1
                            </p>
                        </div>

                        <!-- Error Display -->
                        ${this.error ? `
                        <div class="card-dark mb-6 p-4 border-red-500 fade-in">
                            <div class="flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="h-5 w-5 text-red-400"></i>
                                <span class="text-red-300">${this.error}</span>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Upload Area -->
                        ${!this.uploadedImage ? `
                        <div class="card-dark mb-8">
                            <div class="p-8">
                                <div id="upload-area" class="border-2 border-dashed border-custom-accent rounded-lg p-12 text-center transition-colors hover:border-opacity-80 cursor-pointer">
                                    <i data-lucide="upload" class="h-16 w-16 text-custom-primary mx-auto mb-4"></i>
                                    <h3 class="text-xl font-semibold text-custom-secondary mb-2">
                                        Carica la tua immagine
                                    </h3>
                                    <p class="text-custom-primary mb-6">
                                        Trascina qui il file oppure clicca per selezionare
                                    </p>
                                    <p class="text-sm text-custom-primary mb-6">
                                        Formati supportati: JPG, PNG, WebP, SVG (max 10MB)
                                    </p>
                                    <input type="file" id="file-upload" class="hidden" accept="image/*" />
                                    <button class="btn-primary px-6 py-2 rounded-lg font-medium" onclick="document.getElementById('file-upload').click()">
                                        Seleziona File
                                    </button>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Image Preview -->
                        ${this.uploadedImage ? `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 fade-in">
                            <div class="card-dark">
                                <div class="p-6 border-b border-custom-accent">
                                    <h3 class="text-lg font-semibold text-custom-secondary">Anteprima Immagine</h3>
                                    <p class="text-custom-primary">
                                        ${this.uploadedImage.name} • ${(this.uploadedImage.size / (1024*1024)).toFixed(2)} MB • ${this.uploadedImage.type.split('/')[1].toUpperCase()}
                                    </p>
                                </div>
                                <div class="p-6">
                                    <img src="${this.uploadedImage.url}" alt="Uploaded content" class="w-full h-64 object-contain rounded-lg border border-custom-accent bg-gray-900" />
                                    <div class="mt-4 flex gap-2">
                                        <button id="analyze-btn" ${this.isAnalyzing ? 'disabled' : ''} class="btn-primary px-4 py-2 rounded-lg font-medium flex items-center gap-2 disabled:opacity-50">
                                            ${this.isAnalyzing ? `
                                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-current"></div>
                                                Analizzando...
                                            ` : `
                                                <i data-lucide="eye" class="h-4 w-4"></i>
                                                Avvia Analisi
                                            `}
                                        </button>
                                        <button id="remove-btn" class="btn-secondary px-4 py-2 rounded-lg font-medium">
                                            Rimuovi
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress -->
                            ${this.isAnalyzing ? `
                            <div class="card-dark">
                                <div class="p-6 border-b border-custom-accent">
                                    <h3 class="text-lg font-semibold text-custom-secondary">Analisi in Corso</h3>
                                    <p class="text-custom-primary">Elaborazione con standard aggiornati...</p>
                                </div>
                                <div class="p-6 space-y-4">
                                    ${[
                                        '🖼️ Caricamento Canvas HTML5', 
                                        '🎨 Analisi colori dominanti', 
                                        '📏 Calcolo contrasti WCAG 2.1', 
                                        '📦 CO₂ upload (0.072g/MB)',
                                        '💧 Impatto idrico (103ml/MB)',
                                        '⏱️ CO₂ visualizzazione (6g/min)',
                                        '🎨 Fattore colori OLED',
                                        '📊 Score finale pesato'
                                    ].map(step => `
                                        <div>
                                            <div class="flex justify-between text-sm mb-1 text-custom-secondary">
                                                <span>${step}</span>
                                                <span class="text-custom-primary">✓</span>
                                            </div>
                                            <div class="w-full bg-gray-700 rounded-full h-2">
                                                <div class="bg-custom-primary h-2 rounded-full w-full transition-all duration-300"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}

                        <!-- Results -->
                        ${this.analysisResults ? `
                        <div class="space-y-8 fade-in">
                            <!-- Overall Score -->
                            <div class="card-dark text-center">
                                <div class="p-6">
                                    <h2 class="text-2xl font-bold mb-4 text-custom-secondary">Punteggio Complessivo</h2>
                                    <div class="text-6xl font-bold mb-2 ${this.getScoreColor(this.analysisResults.overall)}">
                                        ${this.analysisResults.overall}
                                    </div>
                                    <span class="inline-block text-lg px-4 py-1 rounded-full ${this.getBadgeClass(this.analysisResults.overall)}">
                                        ${this.getScoreBadge(this.analysisResults.overall)}
                                    </span>
                                    <p class="text-sm text-custom-primary mt-2">
                                        Media pesata: Ambientale (40%) • Accessibilità (35%) • Economica (25%)
                                    </p>
                                </div>
                            </div>

                            <!-- Detailed Scores -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Environmental -->
                                <div class="card-dark">
                                    <div class="p-6 border-b border-custom-accent">
                                        <h3 class="text-lg font-semibold flex items-center gap-2 text-custom-secondary">
                                            <i data-lucide="leaf" class="h-5 w-5 text-custom-primary"></i>
                                            Ambientale
                                        </h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="text-3xl font-bold mb-4 ${this.getScoreColor(this.analysisResults.environmental.score)}">
                                            ${this.analysisResults.environmental.score}/100
                                        </div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between items-center">
                                                <span class="text-custom-primary">📦 CO₂ upload:</span>
                                                <div class="flex items-center">
                                                    <span class="font-medium text-custom-secondary">${this.analysisResults.environmental.co2Upload}g</span>
                                                    <span class="info-icon" data-info="co2_upload">ℹ️</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-custom-primary">💧 Acqua upload:</span>
                                                <div class="flex items-center">
                                                    <span class="font-medium text-custom-secondary">${this.analysisResults.environmental.waterUpload}ml</span>
                                                    <span class="info-icon" data-info="water_upload">ℹ️</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-custom-primary">⏱️ CO₂ view:</span>
                                                <div class="flex items-center">
                                                    <span class="font-medium text-custom-secondary">${this.analysisResults.environmental.co2View}g</span>
                                                    <span class="info-icon" data-info="co2_view">ℹ️</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-custom-primary">🎨 Fattore colore:</span>
                                                <div class="flex items-center">
                                                    <span class="font-medium text-custom-secondary">+${(this.analysisResults.environmental.colorFactor * 100).toFixed(0)}%</span>
                                                    <span class="info-icon" data-info="color_impact">ℹ️</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-custom-primary">🌍 CO₂ totale:</span>
                                                <span class="font-medium text-custom-secondary">${this.analysisResults.environmental.totalCO2}g</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Accessibility -->
                                <div class="card-dark">
                                    <div class="p-6 border-b border-custom-accent">
                                        <h3 class="text-lg font-semibold flex items-center gap-2 text-custom-secondary">
                                            <i data-lucide="eye" class="h-5 w-5 text-custom-primary"></i>
                                            Accessibilità
                                        </h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="text-3xl font-bold mb-4 ${this.getScoreColor(this.analysisResults.accessibility.score)}">
                                            ${this.analysisResults.accessibility.score}/100
                                        </div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between items-center">
                                                <span class="text-custom-primary">Contrasto max:</span>
                                                <div class="flex items-center">
                                                    <span class="font-medium ${this.analysisResults.accessibility.contrastRatio >= 4.5 ? 'text-custom-primary' : 'text-red-400'}">
                                                        ${this.analysisResults.accessibility.contrastRatio}:1
                                                    </span>
                                                    <span class="info-icon" data-info="contrast_wcag">ℹ️</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-custom-primary">Livello WCAG:</span>
                                                <span class="px-2 py-1 rounded text-xs font-medium ${this.getBadgeClass(this.analysisResults.accessibility.score)}">
                                                    ${this.analysisResults.accessibility.wcagLevel}
                                                </span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-custom-primary">Testo alt:</span>
                                                <div class="flex items-center">
                                                    <span class="text-custom-secondary">${this.analysisResults.accessibility.hasAltText ? '✅' : '❌'}</span>
                                                    <span class="info-icon" data-info="alt_text">ℹ️</span>
                                                </div>

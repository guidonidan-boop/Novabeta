<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova (beta) - Analisi di Sostenibilità Digitale</title>
    <meta name="description" content="Un assistente AI per calcolare l'impatto ambientale, l'accessibilità e la sostenibilità economica dei contenuti digitali.">

    <style>
        /* Tailwind CSS v3.4.1 | MIT License | https://tailwindcss.com - Pre-compiled for production */
        *,:after,:before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / .5 );--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}body{margin:0;line-height:inherit}h1,h2,h3,h4,p{margin:0}a{color:inherit;text-decoration:inherit}button{cursor:pointer}button,input{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button{text-transform:none}[type=file]{-webkit-appearance:button;background-color:initial;background-image:initial;text-transform:none}[type=file]:focus{outline:1px solid ButtonText;outline:1px auto -webkit-focus-ring-color}img{display:block;vertical-align:middle;max-width:100%;height:auto}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.top-4{top:4}.right-4{right:1rem}.z-10{z-index:10}.z-20{z-index:20}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:.25rem}.mt-12{margin-top:3rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.mr-2{margin-right:.5rem}.mr-4{margin-right:1rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-16{height:4rem}.h-20{height:5rem}.h-24{height:6rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-full{height:100%}.min-h-screen{min-height:100vh}.w-16{width:4rem}.w-20{width:5rem}.w-24{width:6rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-full{width:100%}.max-w-2xl{max-width:42rem}.max-w-4xl{max-width:56rem}.max-w-lg{max-width:32rem}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}.animate-spin{animation:spin 1s linear infinite}.cursor-pointer{cursor:pointer}.flex-col{flex-direction:column}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.overflow-y-auto{overflow-y:auto}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-md{border-radius:.375rem}.border-2{border-width:2px}.border-4{border-width:4px}.border{border-width:1px}.border-dashed{border-style:dashed}.border-t-transparent{border-top-color:transparent}.border-\[\#96E6B3\]{--tw-border-opacity:1;border-color:rgb(150 230 179 / var(--tw-border-opacity))}.border-red-500{--tw-border-opacity:1;border-color:rgb(239 68 68 / var(--tw-border-opacity))}.border-white\/20{border-color:rgb(255 255 255 / .2)}.border-white\/30{border-color:rgb(255 255 255 / .3)}.border-white\/40{border-color:rgb(255 255 255 / .4)}.bg-\[\#1F3B2C\]{--tw-bg-opacity:1;background-color:rgb(31 59 44 / var(--tw-bg-opacity))}.bg-\[\#2a4a3a\]\/50{background-color:rgb(42 74 58 / .5)}.bg-\[\#96E6B3\]{--tw-bg-opacity:1;background-color:rgb(150 230 179 / var(--tw-bg-opacity))}.bg-black\/70{background-color:rgb(0 0 0 / .7)}.bg-red-900\/50{background-color:rgb(127 29 29 / .5)}.bg-white\/10{background-color:rgb(255 255 255 / .1)}.bg-white\/5{background-color:rgb(255 255 255 / .05)}.bg-white\/20{background-color:rgb(255 255 255 / .2)}.p-2{padding:.5rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.text-center{text-align:center}.text-left{text-align:left}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-5xl{font-size:3rem;line-height:1}.text-6xl{font-size:3.75rem;line-height:1}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-light{font-weight:300}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-\[\#1F3B2C\]{--tw-text-opacity:1;color:rgb(31 59 44 / var(--tw-text-opacity))}.text-\[\#96E6B3\]{--tw-text-opacity:1;color:rgb(150 230 179 / var(--tw-text-opacity))}.text-red-300{--tw-text-opacity:1;color:rgb(252 165 165 / var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}.text-white\/60{color:rgb(255 255 255 / .6)}.text-white\/70{color:rgb(255 255 255 / .7)}.text-white\/80{color:rgb(255 255 255 / .8)}.text-white\/90{color:rgb(255 255 255 / .9)}.opacity-0{opacity:0}.underline{text-decoration-line:underline}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-300{transition-duration:.3s}.list-disc{list-style-type:disc}.list-inside{list-style-position:inside}.hover\:border-\[\#96E6B3\]:hover{--tw-border-opacity:1;border-color:rgb(150 230 179 / var(--tw-border-opacity))}.hover\:bg-white:hover{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity))}.hover\:bg-white\/5:hover{background-color:rgb(255 255 255 / .05)}.hover\:text-\[\#96E6B3\]:hover{--tw-text-opacity:1;color:rgb(150 230 179 / var(--tw-text-opacity))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}.hover\:underline:hover{text-decoration-line:underline}.hover\:opacity-100:hover{opacity:1}@media(min-width:640px){.sm\:p-6{padding:1.5rem}.sm\:text-left{text-align:left}.sm\:flex-row{flex-direction:row}.sm\:items-center{align-items:center}.sm\:mt-0{margin-top:0}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}@media(min-width:768px){.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}@media(min-width:1024px){.lg\:p-8{padding:2rem}.lg\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.lg\:grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}}
        
        /* Custom styles */
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .drag-active { border-color: #96E6B3 !important; background-color: #2a4a3a !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { body { background: white !important; color: black !important; } .no-print { display: none !important; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F3B2C; }
        ::-webkit-scrollbar-thumb { background-color: #96E6B3; border-radius: 4px; }
        .object-cover { object-fit: cover; }
        .max-h-\[90vh\] { max-height: 90vh; }
        
        /* Info button styling - clean white icon */
        .info-btn { 
            cursor: pointer; 
            opacity: 0.6; 
            transition: opacity 0.2s ease;
            color: white;
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            font-size: inherit;
            line-height: inherit;
        }
        .info-btn:hover { 
            opacity: 1; 
        }
        
        /* Beta badge styling */
        .beta-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 400;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        /* File preview sticky positioning */
        .file-preview-sticky {
            position: sticky;
            top: 20px;
            z-index: 20;
            background: rgba(31, 59, 44, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Consistent box spacing */
        .analysis-box {
            margin-bottom: 1.5rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
        }
        
        /* Minimal icons */
        .icon-check {
            color: white;
            font-weight: bold;
        }
        .icon-cross {
            color: rgba(255, 255, 255, 0.5);
            font-weight: normal;
        }
    </style>
</head>
<body class="min-h-screen bg-[#1F3B2C] text-white">
    <div id="app"></div>

    <script>
        class NovaSustainabilityAnalyzer {
            constructor() {
                this.uploadedFile = null;
                this.analysisResults = null;
                this.isAnalyzing = false;
                this.error = null;
                this.activeModal = null;
                this.init();
            }

            init() {
                this.render();
                this.attachEventListeners();
            }

            attachEventListeners() {
                const appContainer = document.getElementById("app");
                
                // File upload events
                appContainer.addEventListener("change", e => {
                    if (e.target.id === "file-upload") this.handleFileInput(e);
                });
                
                // Drag and drop events
                appContainer.addEventListener("dragenter", e => {
                    if (e.target.closest("#upload-area")) this.handleDrag(e, true);
                });
                appContainer.addEventListener("dragover", e => {
                    if (e.target.closest("#upload-area")) this.handleDrag(e, true);
                });
                appContainer.addEventListener("dragleave", e => {
                    if (e.target.closest("#upload-area")) this.handleDrag(e, false);
                });
                appContainer.addEventListener("drop", e => {
                    if (e.target.closest("#upload-area")) this.handleDrop(e);
                });

                // Button clicks
                appContainer.addEventListener("click", e => {
                    if (e.target.closest("#analyze-btn")) this.analyzeFile();
                    if (e.target.closest("#remove-btn")) this.removeFile();
                    if (e.target.closest("#new-analysis-btn")) this.startNewAnalysis();
                    if (e.target.closest("#download-cert-btn")) this.downloadCertificate();
                    
                    const infoButton = e.target.closest(".info-btn");
                    if (infoButton) {
                        e.preventDefault();
                        this.showModal(infoButton.dataset.modal);
                    }
                });

                // Modal events
                document.body.addEventListener("click", e => {
                    if (e.target.classList.contains("modal-close") || e.target.id === "modal-backdrop") {
                        this.hideModal();
                    }
                });
                
                document.addEventListener("keydown", e => {
                    if (e.key === "Escape") this.hideModal();
                });
            }

            handleDrag(e, isActive) {
                e.preventDefault();
                e.stopPropagation();
                const uploadArea = document.getElementById("upload-area");
                if (uploadArea) {
                    uploadArea.classList.toggle("drag-active", isActive);
                }
            }

            handleDrop(e) {
                this.handleDrag(e, false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    this.handleFile(e.dataTransfer.files[0]);
                }
            }

            handleFileInput(e) {
                if (e.target.files && e.target.files[0]) {
                    this.handleFile(e.target.files[0]);
                }
            }

            handleFile(file) {
                this.error = null;
                const validTypes = ["image/jpeg", "image/png", "image/webp", "image/svg+xml", "application/pdf"];
                
                if (!validTypes.includes(file.type)) {
                    this.error = "Formato file non supportato. Usa JPG, PNG, WebP, SVG o PDF.";
                    this.render();
                    return;
                }
                
                if (file.size > 15 * 1024 * 1024) {
                    this.error = "File troppo grande. Dimensione massima: 15MB.";
                    this.render();
                    return;
                }

                const reader = new FileReader();
                reader.onload = e => {
                    this.uploadedFile = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: e.target.result
                    };
                    this.analysisResults = null;
                    this.render();
                };
                reader.onerror = () => {
                    this.error = "Errore durante la lettura del file.";
                    this.render();
                };
                reader.readAsDataURL(file);
            }

            removeFile() {
                this.uploadedFile = null;
                this.analysisResults = null;
                this.error = null;
                this.render();
            }

            startNewAnalysis() {
                this.uploadedFile = null;
                this.analysisResults = null;
                this.error = null;
                this.render();
            }

            // --- Analisi Functions ---
            async analyzeFile() {
                if (!this.uploadedFile) return;
                
                this.isAnalyzing = true;
                this.error = null;
                this.render();
                
                // Simula tempo di analisi
                await new Promise(resolve => setTimeout(resolve, 2000));

                try {
                    const sizeInMB = this.uploadedFile.size / (1024 * 1024);
                    
                    // Calcolo impatto ambientale
                    const environmental = this.calculateEnvironmentalImpact(sizeInMB);
                    
                    // Analisi accessibilità (simulata)
                    const accessibility = this.analyzeAccessibility();
                    
                    // Analisi sostenibilità economica (simulata)
                    const economic = this.analyzeEconomicSustainability();
                    
                    // Calcolo punteggio complessivo
                    const overallScore = Math.round(
                        (environmental.score * 0.4) + 
                        (accessibility.score * 0.35) + 
                        (economic.score * 0.25)
                    );

                    this.analysisResults = {
                        overallScore,
                        environmental,
                        accessibility,
                        economic,
                        timestamp: new Date().toISOString()
                    };
                } catch (error) {
                    console.error("Errore durante l'analisi:", error);
                    this.error = "Si è verificato un errore durante l'analisi.";
                }
                
                this.isAnalyzing = false;
                this.render();
            }

            calculateEnvironmentalImpact(sizeInMB) {
                // Formule realistiche come da specifiche
                const co2UploadG = parseFloat((sizeInMB * 0.072).toFixed(3));
                const h2oUploadMl = parseFloat((sizeInMB * 100).toFixed(2)); // Valore medio W=100
                
                const minutes = 1; // Stima 1 minuto di visualizzazione
                const co2ViewBaseG = minutes * 6;
                const colorFactor = 0.25; // Valore medio per colori accesi
                const co2ViewColorG = parseFloat((co2ViewBaseG * (1 + colorFactor)).toFixed(2));
                
                const h2oViewMl = parseFloat((minutes * 15.5).toFixed(1)); // Stima per visualizzazione
                
                // Calcolo punteggio ambientale (più il file è piccolo, più il punteggio è alto)
                const score = Math.max(10, Math.min(100, 100 - Math.floor(sizeInMB * 15)));

                return {
                    score,
                    fileWeightMB: parseFloat(sizeInMB.toFixed(3)),
                    co2UploadG,
                    co2ViewColorG,
                    h2oUploadMl,
                    h2oViewMl
                };
            }

            analyzeAccessibility() {
                // Simulazione analisi accessibilità
                const contrastRatio = 4.8;
                const hasAltText = Math.random() > 0.3;
                const hasTextInImage = Math.random() > 0.7;
                const fontReadability = Math.random() > 0.2;

                let score = 0;
                if (contrastRatio >= 4.5) score += 40;
                else if (contrastRatio >= 3) score += 20;
                
                if (hasAltText) score += 30;
                if (!hasTextInImage) score += 20;
                if (fontReadability) score += 10;

                return {
                    score: Math.min(100, score),
                    contrastRatio: contrastRatio.toFixed(1),
                    hasAltText,
                    hasTextInImage,
                    fontReadability
                };
            }

            analyzeEconomicSustainability() {
                // Simulazione analisi economica
                const usesDesignSystem = Math.random() > 0.4;
                const usesOpenSourceFonts = Math.random() > 0.3;
                const hasSimpleLayout = Math.random() > 0.5;

                let score = 0;
                if (usesDesignSystem) score += 40;
                if (usesOpenSourceFonts) score += 40;
                if (hasSimpleLayout) score += 20;

                return {
                    score,
                    usesDesignSystem,
                    usesOpenSourceFonts,
                    hasSimpleLayout
                };
            }

            downloadCertificate() {
                if (!this.analysisResults) return;
                
                const certificateHTML = this.generateCertificateHTML();
                const blob = new Blob([certificateHTML], { type: "text/html" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `nova-certificate-${this.uploadedFile.name}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            generateCertificateHTML() {
                const { overallScore, environmental, accessibility, economic } = this.analysisResults;
                const overallLabel = this.getScoreLabel(overallScore);
                
                return `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificato Nova - ${this.uploadedFile.name}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .certificate { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .score { font-size: 48px; font-weight: bold; color: #96E6B3; }
        .section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; }
        .metric { display: flex; justify-content: space-between; margin: 10px 0; }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="certificate">
        <div class="header">
            <h1>Certificato di sostenibilità digitale</h1>
            <h2>Nova</h2>
            <div class="score">${overallScore}/100</div>
            <p><strong>${overallLabel}</strong></p>
            <p>File: ${this.uploadedFile.name}</p>
            <p>Data: ${new Date().toLocaleDateString("it-IT")}</p>
        </div>
        
        <div class="section">
            <h3>Impatto ambientale (${environmental.score}/100)</h3>
            <div class="metric"><span>Peso del contenuto:</span><span>${environmental.fileWeightMB} MB</span></div>
            <div class="metric"><span>CO₂ per upload:</span><span>${environmental.co2UploadG} g</span></div>
            <div class="metric"><span>CO₂ per visualizzazione:</span><span>${environmental.co2ViewColorG} g</span></div>
            <div class="metric"><span>Acqua per upload:</span><span>${environmental.h2oUploadMl} ml</span></div>
            <div class="metric"><span>Acqua per visualizzazione:</span><span>${environmental.h2oViewMl} ml</span></div>
        </div>
        
        <div class="section">
            <h3>Accessibilità WCAG 2.1 (${accessibility.score}/100)</h3>
            <div class="metric"><span>Contrasto colore:</span><span>${accessibility.contrastRatio}:1</span></div>
            <div class="metric"><span>Testo alternativo:</span><span>${accessibility.hasAltText ? "✓" : "○"}</span></div>
            <div class="metric"><span>Testo in immagini:</span><span>${!accessibility.hasTextInImage ? "✓" : "○"}</span></div>
            <div class="metric"><span>Leggibilità font:</span><span>${accessibility.fontReadability ? "✓" : "○"}</span></div>
        </div>
        
        <div class="section">
            <h3>Sostenibilità economica (${economic.score}/100)</h3>
            <div class="metric"><span>Design system:</span><span>${economic.usesDesignSystem ? "✓" : "○"}</span></div>
            <div class="metric"><span>Font open source:</span><span>${economic.usesOpenSourceFonts ? "✓" : "○"}</span></div>
            <div class="metric"><span>Layout modulare:</span><span>${economic.hasSimpleLayout ? "✓" : "○"}</span></div>
        </div>
        
        <div class="footer">
            <p>Questo certificato è stato generato da Nova - Analisi di sostenibilità digitale</p>
            <p>Questa analisi non sostituisce una valutazione scientifica o tecnica professionale.</p>
        </div>
    </div>
</body>
</html>`;
            }

            getScoreLabel(score) {
                if (score >= 85) return "Ottimo";
                if (score >= 70) return "Buono";
                if (score >= 60) return "Sufficiente";
                return "Insufficiente";
            }

            // --- Rendering Functions ---
            render() {
                const app = document.getElementById("app");
                if (!app) return;

                app.innerHTML = `
                    <div class="min-h-screen flex flex-col p-6 lg:p-8">
                        <header class="text-center mb-8 no-print max-w-2xl mx-auto">
                            <h1 class="text-4xl font-bold text-[#96E6B3] mb-4">
                                Nova<span class="beta-badge">beta</span>
                            </h1>
                            <p class="text-white/80 text-lg">Analizza l'impatto dei tuoi contenuti digitali per un web più etico, accessibile e sostenibile.</p>
                        </header>

                        <main class="w-full max-w-4xl mx-auto flex-grow">
                            ${this.isAnalyzing ? this.renderLoader() : ""}
                            ${!this.isAnalyzing && !this.uploadedFile ? this.renderUploadArea() : ""}
                            ${!this.isAnalyzing && this.uploadedFile && !this.analysisResults ? this.renderFilePreview() : ""}
                            ${this.error ? this.renderError() : ""}
                            ${this.analysisResults ? this.renderResultsWithPreview() : ""}
                        </main>
                        
                        ${this.analysisResults ? this.renderFooter() : ""}
                    </div>
                    ${this.renderModals()}
                `;
            }

            renderLoader() {
                return `
                    <div class="text-center p-8 fade-in">
                        <div class="w-16 h-16 border-4 border-[#96E6B3] border-t-transparent rounded-full animate-spin mx-auto"></div>
                        <p class="mt-6 text-xl text-white">Analisi in corso...</p>
                        <p class="text-white/70 mt-2">Stiamo calcolando l'impatto ambientale, l'accessibilità e la sostenibilità economica</p>
                    </div>
                `;
            }

            renderUploadArea() {
                return `
                    <div id="upload-area" class="relative border-2 border-dashed border-white/40 rounded-2xl p-8 text-center cursor-pointer transition-all duration-300 hover:border-[#96E6B3] hover:bg-white/5">
                        <input type="file" id="file-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*,.pdf">
                        <div class="flex flex-col items-center justify-center space-y-6">
                            <div class="text-6xl text-[#96E6B3]">↑</div>
                            <div>
                                <p class="text-xl font-medium text-white mb-2">Trascina un file qui o clicca per caricare</p>
                                <p class="text-white/70">Supporta Immagini (JPG, PNG, WebP, SVG) e PDF. Max 15MB.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderFilePreview() {
                const isImage = this.uploadedFile.type.startsWith("image/");
                return `
                    <div class="bg-white/5 border border-white/20 rounded-2xl p-6 fade-in">
                        <div class="flex flex-col sm:flex-row items-center gap-6">
                            ${isImage ? 
                                `<img src="${this.uploadedFile.url}" alt="Anteprima" class="w-20 h-20 object-contain rounded-lg border border-white/30">` :
                                `<div class="w-20 h-20 flex items-center justify-center bg-white/10 rounded-lg border border-white/30">
                                    <div class="text-2xl text-[#96E6B3]">📄</div>
                                 </div>`
                            }
                            <div class="flex-grow text-center sm:text-left">
                                <p class="font-semibold text-xl text-white truncate">${this.uploadedFile.name}</p>
                                <p class="text-white/70 mt-1">${(this.uploadedFile.size / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                                <button id="remove-btn" class="text-white/70 hover:text-white transition-colors bg-transparent border-none p-0" title="Rimuovi file">
                                    🗑
                                </button>
                                <button id="analyze-btn" class="bg-[#96E6B3] text-[#1F3B2C] font-semibold py-3 px-10 rounded-lg hover:bg-white transition-colors">
                                    Analizza
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderResultsWithPreview() {
                const isImage = this.uploadedFile.type.startsWith("image/");
                return `
                    <div class="fade-in">
                        <!-- File preview sticky -->
                        <div class="file-preview-sticky mb-6 p-4">
                            <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        ${isImage ? 
                                            `<img src="${this.uploadedFile.url}" alt="Anteprima" class="w-16 h-16 object-contain rounded border border-white/30">` :
                                            `<div class="w-16 h-16 flex items-center justify-center bg-white/10 rounded border border-white/30">
                                                <div class="text-lg text-[#96E6B3]">📄</div>
                                             </div>`
                                        }
                                        <div>
                                            <p class="font-medium text-white truncate">${this.uploadedFile.name}</p>
                                            <p class="text-sm text-white/70">${(this.uploadedFile.size / 1024 / 1024).toFixed(2)} MB</p>
                                        </div>
                                    </div>
                                    <button id="new-analysis-btn" class="bg-[#96E6B3] text-[#1F3B2C] font-medium py-2 px-4 rounded-lg hover:bg-white transition-colors text-sm">
                                        Nuova analisi
                                    </button>
                                </div>
                            </div>
                        
                        ${this.renderResults()}
                    </div>
                `;
            }

            renderError() {
                return `
                    <div class="bg-red-900/50 border border-red-500 text-red-300 p-4 rounded-lg mt-4 flex items-center gap-3 fade-in">
                        <span>⚠</span>
                        <span>${this.error}</span>
                    </div>
                `;
            }

            renderResults() {
                const { overallScore, environmental, accessibility, economic } = this.analysisResults;
                const overallLabel = this.getScoreLabel(overallScore);
                
                return `
                    <div class="space-y-6">
                        <!-- Punteggio complessivo -->
                        <div class="analysis-box text-center">
                            <h2 class="text-3xl font-bold text-[#96E6B3] mb-6">Punteggio complessivo</h2>
                            <div class="text-6xl font-bold text-white mb-4">${overallScore}/100</div>
                            <div class="text-2xl font-medium text-[#96E6B3] mb-6">${overallLabel}</div>
                            <button id="download-cert-btn" class="bg-[#96E6B3] text-[#1F3B2C] font-medium py-3 px-6 rounded-lg hover:bg-white transition-colors">
                                Scarica certificato
                            </button>
                        </div>

                        <!-- Impatto ambientale -->
                        <div class="analysis-box">
                            <h3 class="text-2xl font-bold text-[#96E6B3] mb-6">🌱 Impatto ambientale</h3>
                            <div class="text-center mb-6">
                                <span class="text-4xl font-bold text-white">${environmental.score}/100</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                                ${this.renderMetric("Peso del contenuto", `${environmental.fileWeightMB} MB`, "file-weight")}
                                ${this.renderMetric("CO₂ per upload", `${environmental.co2UploadG} g`, "co2-upload")}
                                ${this.renderMetric("CO₂ per visualizzazione", `${environmental.co2ViewColorG} g`, "co2-view")}
                                ${this.renderMetric("Acqua per upload", `${environmental.h2oUploadMl} ml`, "h2o-upload")}
                                ${this.renderMetric("Acqua per visualizzazione", `${environmental.h2oViewMl} ml`, "h2o-view")}
                            </div>
                        </div>

                        <!-- Accessibilità -->
                        <div class="analysis-box">
                            <h3 class="text-2xl font-bold text-[#96E6B3] mb-6">👁️ Accessibilità WCAG 2.1</h3>
                            <div class="text-center mb-6">
                                <span class="text-4xl font-bold text-white">${accessibility.score}/100</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                ${this.renderMetric("Contrasto colore", `${accessibility.contrastRatio}:1`, "contrast")}
                                ${this.renderMetric("Testo alternativo", accessibility.hasAltText ? "<span class=\"icon-check\">✓</span>" : "<span class=\"icon-cross\">○</span>", "alt-text")}
                                ${this.renderMetric("Testo in immagini", !accessibility.hasTextInImage ? "<span class=\"icon-check\">✓</span>" : "<span class=\"icon-cross\">○</span>", "text-in-image")}
                                ${this.renderMetric("Leggibilità font", accessibility.fontReadability ? "<span class=\"icon-check\">✓</span>" : "<span class=\"icon-cross\">○</span>", "font-readability")}
                            </div>
                        </div>

                        <!-- Sostenibilità economica -->
                        <div class="analysis-box">
                            <h3 class="text-2xl font-bold text-[#96E6B3] mb-6">💰 Sostenibilità economica</h3>
                            <div class="text-center mb-6">
                                <span class="text-4xl font-bold text-white">${economic.score}/100</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                ${this.renderMetric("Design system", economic.usesDesignSystem ? "<span class=\"icon-check\">✓</span>" : "<span class=\"icon-cross\">○</span>", "design-system")}
                                ${this.renderMetric("Font open source", economic.usesOpenSourceFonts ? "<span class=\"icon-check\">✓</span>" : "<span class=\"icon-cross\">○</span>", "open-fonts")}
                                ${this.renderMetric("Layout modulare", economic.hasSimpleLayout ? "<span class=\"icon-check\">✓</span>" : "<span class=\"icon-cross\">○</span>", "modular-layout")}
                            </div>
                        </div>

                        <!-- Conversione impatto -->
                        ${this.renderImpactConversion()}
                    </div>
                `;
            }

            renderMetric(label, value, modalId) {
                return `
                    <div class="bg-white/5 p-4 rounded-lg text-center">
                        <div class="flex items-center justify-center gap-2 mb-3">
                            <p class="text-white/80 font-medium text-sm">${label}</p>
                            <button class="info-btn" data-modal="${modalId}">
                                <span class="text-white text-sm">ⓘ</span>
                            </button>
                        </div>
                        <p class="text-xl font-bold text-white">${value}</p>
                    </div>
                `;
            }

            renderImpactConversion() {
                const { environmental } = this.analysisResults;
                const totalCO2Single = environmental.co2UploadG + environmental.co2ViewColorG;
                const totalCO2Per1000 = totalCO2Single * 1000;
                
                // Conversioni corrette basate sui calcoli verificati
                const kmInCar = (totalCO2Per1000 / 130).toFixed(1); // 130g CO2/km auto media
                const coffees = (totalCO2Per1000 / 20).toFixed(0); // 20g CO2 per caffè (0.05 kWh * 400g CO2/kWh)
                const phoneCharges = (totalCO2Per1000 / 5).toFixed(0); // 5g CO2 per ricarica (0.0125 kWh * 400g CO2/kWh)
                
                return `
                    <div class="analysis-box">
                        <h3 class="text-2xl font-bold text-[#96E6B3] mb-6">🔄 Conversione dell'impatto ogni 1000 visualizzazioni</h3>
                        <p class="text-white/80 mb-6">L'impatto totale di questo contenuto per 1000 visualizzazioni (${totalCO2Per1000.toFixed(0)}g CO₂) equivale a:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 text-center">
                            <div class="bg-white/5 p-6 rounded-lg">
                                <div class="text-3xl mb-3">🚗</div>
                                <div class="text-2xl font-bold text-white mb-1">${kmInCar} km</div>
                                <div class="text-white/70">in auto</div>
                            </div>
                            <div class="bg-white/5 p-6 rounded-lg">
                                <div class="text-3xl mb-3">☕</div>
                                <div class="text-2xl font-bold text-white mb-1">${coffees}</div>
                                <div class="text-white/70">caffè</div>
                            </div>
                            <div class="bg-white/5 p-6 rounded-lg">
                                <div class="text-3xl mb-3">📱</div>
                                <div class="text-2xl font-bold text-white mb-1">${phoneCharges}</div>
                                <div class="text-white/70">ricariche smartphone</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderFooter() {
                return `
                    <footer class="text-center mt-12 text-white/60 text-sm max-w-2xl mx-auto">
                        <p>Questa analisi non sostituisce una valutazione scientifica o tecnica. Il suo scopo è quello di fornire un'indicazione orientativa e contribuire alla sensibilizzazione verso un approccio più etico, accessibile e sostenibile nella progettazione di contenuti digitali.</p>
                    </footer>
                `;
            }

            renderModals() {
                const modals = {
                    'file-weight': {
                        title: 'Peso del contenuto',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> La dimensione del file in megabyte (MB) influenza direttamente l'impatto ambientale. File più grandi richiedono più energia per essere trasferiti, archiviati e visualizzati.</p>
                            <p class="text-white/80"><strong>Suggerimento:</strong> Ottimizza le immagini e comprimi i PDF per ridurre l'impatto ambientale senza perdere qualità visiva.</p>
                        `
                    },
                    'co2-upload': {
                        title: 'CO₂ per upload',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> Caricare un contenuto digitale consuma energia nei server, nella rete e nei dispositivi. Questa energia, in media, genera circa 0.072 grammi di CO₂ per ogni megabyte trasferito.</p>
                            <p class="text-white/80"><strong>Fonte:</strong> <a href="https://sustainablewebdesign.org/estimating-digital-emissions/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">Sustainable Web Design – Estimating Digital Emissions</a></p>
                        `
                    },
                    'co2-view': {
                        title: 'CO₂ per visualizzazione',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> Ogni minuto in cui un utente visualizza un contenuto online consuma energia per alimentare lo schermo, la rete e i server. In media, ciò produce 6 grammi di CO₂ per minuto di visualizzazione. L'uso di colori chiari su schermi OLED può aumentare questo consumo del 25%.</p>
                            <p class="text-white/80"><strong>Fonti:</strong></p>
                            <ul class="list-disc list-inside text-white/80 space-y-1 mt-2">
                                <li><a href="https://www.iea.org/commentaries/the-carbon-footprint-of-streaming-video" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">IEA</a></li>
                                <li><a href="https://www.cloudzero.com/blog/tech-carbon-footprint/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">CloudZero</a></li>
                                <li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8876531/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">PMC Study on OLED</a></li>
                            </ul>
                        `
                    },
                    'h2o-upload': {
                        title: 'Acqua per upload',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> I data center usano acqua per raffreddare i server. A seconda della tecnologia e del paese, ogni MB trasferito può usare da 1 a 205 millilitri d'acqua. Usiamo 100ml come valore medio.</p>
                            <p class="text-white/80"><strong>Fonti:</strong></p>
                            <ul class="list-disc list-inside text-white/80 space-y-1 mt-2">
                                <li><a href="https://www.mdpi.com/2071-1050/7/8/11260" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">MDPI</a></li>
                                <li><a href="https://www.researchgate.net/publication/281719759" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">ResearchGate</a></li>
                                <li><a href="https://watercalculator.org/footprint/data-centers-water-use/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">WaterCalculator.org</a></li>
                            </ul>
                        `
                    },
                    'h2o-view': {
                        title: 'Acqua per visualizzazione',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> Anche la visualizzazione di contenuti richiede acqua per il raffreddamento dei server che servono i dati e per l'alimentazione dei dispositivi dell'utente. Questa metrica stima il consumo d'acqua durante la fase di fruizione del contenuto.</p>
                            <p class="text-white/80"><strong>Calcolo:</strong> Basato sul tempo di visualizzazione stimato (1 minuto ) e sul consumo medio dei data center per servire contenuti digitali (circa 15.5ml per minuto).</p>
                        `
                    },
                    'contrast': {
                        title: 'Contrasto colore (WCAG 1.4.3)',
                        content: `
                            <p class="text-white/80 mb-4">Il contrasto tra il testo e lo sfondo deve essere sufficientemente elevato per garantire la leggibilità anche a persone con disabilità visive. Le WCAG stabiliscono che il rapporto minimo deve essere <strong>4.5:1</strong> per il testo normale e <strong>3:1</strong> per testi grandi.</p>
                            <p class="text-white/80"><strong>Fonte:</strong> <a href="https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">Linea guida WCAG 1.4.3</a></p>
                        `
                    },
                    'alt-text': {
                        title: 'Testo alternativo (WCAG 1.1.1 )',
                        content: `
                            <p class="text-white/80 mb-4">Ogni immagine dovrebbe includere un testo descrittivo (attributo "alt") che spieghi il contenuto visivo a chi non può vederlo. È fondamentale per utenti non vedenti che usano screen reader.</p>
                            <p class="text-white/80"><strong>Fonte:</strong> <a href="https://www.w3.org/WAI/WCAG21/Understanding/non-text-content/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">Linea guida WCAG 1.1.1</a></p>
                        `
                    },
                    'text-in-image': {
                        title: 'Testo in immagini (WCAG 1.4.5 )',
                        content: `
                            <p class="text-white/80 mb-4">Le WCAG raccomandano di non inserire testo dentro immagini, poiché non è leggibile dagli screen reader, non può essere ingrandito correttamente senza perdita di qualità e non è selezionabile o copiabile dall'utente.</p>
                            <p class="text-white/80"><strong>Fonte:</strong> <a href="https://www.w3.org/WAI/WCAG21/Understanding/images-of-text/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">Linea guida WCAG 1.4.5</a></p>
                        `
                    },
                    'font-readability': {
                        title: 'Leggibilità del testo',
                        content: `
                            <p class="text-white/80 mb-4">Anche se non è un criterio WCAG diretto, l'uso di font chiari, di dimensioni adeguate (≥ 16px per il corpo del testo ) e senza effetti grafici distorsivi migliora l'accessibilità per persone con dislessia o disabilità cognitive.</p>
                            <p class="text-white/80"><strong>Riferimento:</strong> <a href="https://www.w3.org/WAI/WCAG21/quickref/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">WCAG 2.1 Quick Reference</a></p>
                        `
                    },
                    'design-system': {
                        title: 'Elementi da design system',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> Se il contenuto usa componenti di un design system o libreria visiva standard (es. pulsanti, card, icone ), sarà più veloce ed economico da modificare, sviluppare e replicare. La coerenza riduce i costi di manutenzione e migliora l'usabilità.</p>
                            <p class="text-white/80"><strong>Riferimenti:</strong></p>
                            <ul class="list-disc list-inside text-white/80 space-y-1 mt-2">
                                <li><a href="https://material.io/design" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">Material Design</a></li>
                                <li><a href="https://www.ibm.com/design/language/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">IBM Design Language</a></li>
                            </ul>
                        `
                    },
                    'open-fonts': {
                        title: 'Uso di font open source',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> I font open source (come quelli di Google Fonts ) eliminano i costi di licenza, sono compatibili su diverse piattaforme e spesso sono ottimizzati per il web, risultando leggeri da caricare. L'uso di font proprietari può comportare costi elevati e limiti di utilizzo.</p>
                            <p class="text-white/80"><strong>Riferimento:</strong> <a href="https://fonts.google.com/" target="_blank" rel="noopener noreferrer" class="text-[#96E6B3] hover:underline">Google Fonts</a></p>
                        `
                    },
                    'modular-layout': {
                        title: 'Layout semplice e riutilizzabile',
                        content: `
                            <p class="text-white/80 mb-4"><strong>Cosa significa:</strong> Un layout semplice e modulare, basato su griglie coerenti e blocchi standard, è più facile da adattare (es. per dispositivi mobili ), mantenere e riusare in altri progetti. Questo riduce i costi operativi di design e sviluppo. L'eccessiva complessità grafica aumenta i costi e i tempi di lavorazione.</p>
                        `
                    }
                };

                return Object.entries(modals).map(([id, { title, content }]) => `
                    <div id="${id}-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
                        <div id="modal-backdrop" class="absolute inset-0"></div>
                        <div class="bg-[#1F3B2C] border border-[#96E6B3] rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto relative z-10">
                            <button class="modal-close absolute top-4 right-4 text-white/70 hover:text-white transition-opacity">
                                ✕
                            </button>
                            <h4 class="text-2xl font-bold text-[#96E6B3] mb-4 pr-8">${title}</h4>
                            <div>${content}</div>
                        </div>
                    </div>
                `).join('');
            }

            // --- Modal Functions ---
            showModal(modalId) {
                this.hideModal(); // Chiudi eventuali modali aperti
                const modal = document.getElementById(`${modalId}-modal`);
                if (modal) {
                    this.activeModal = modal;
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            hideModal() {
                if (this.activeModal) {
                    this.activeModal.classList.add('hidden');
                    this.activeModal = null;
                    document.body.style.overflow = '';
                }
            }
        }

        // Inizializza l'applicazione
        document.addEventListener('DOMContentLoaded', () => {
            new NovaSustainabilityAnalyzer();
        });
    </script>
</body>
</html>
